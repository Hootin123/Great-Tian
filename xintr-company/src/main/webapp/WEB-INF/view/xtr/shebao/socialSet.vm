<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>社保设置</title>
    #parse("comm/head.vm")
</head>
<style>
    body,html{width:100%;}
    .salaset { width:90%;margin:0 auto;font-size: 12px;color: #666666;min-width: 960px;}
    .salaset-title{width: 100%; height: 80px;position: relative}
    .salaset-title h2{text-align: center;line-height: 80px;border-bottom: 1px solid #dbe9ee;color:#000;font-size:25px}
    .salaset-title .topImg{position: absolute;right:25px;top:0;bottom:0;margin:auto;cursor: pointer;}
    .all{width:90%;margin:40px auto 0;}
    table{width:100%;}
    td{border:1px solid #dbe9ee;height: 44px}
    td span{color:#fea811;line-height: 45px}
    .oneTitle{width:15%;text-align: center;background:#f1f9fc;color:#666;}
    /*.oneCon ul{display:none}*/
    .oneCon{width:100%;height:100%;color:#333;text-indent: 40px; position: relative;}
    .oneCon .sit{width:200px;height:100%;background:url(#springUrl('/resource/img/san.png')) no-repeat 180px center;}
    .oneImg{position: relative}
    .oneImg1,.oneImg2{position: absolute;left:40px;top:0;bottom:0;margin:auto;}
    .oneTxte{padding-left:40px; position: relative;}
    .oneTxte input{border:0;}
    .part{width:100%;height:45px;border:1px solid #dbe9ee;background:#f1f9fc;margin:20px auto;line-height:45px;color:#666;}
    .toCon{background:#5b7798;color:#fff;}
    .toNav{border:1px solid #dbe9ee;background:#f1f9fc;}
    .footer{width:100%;height:80px;border:1px solid #dbe9ee;background:#f1f9fc;overflow: hidden;margin-top:20px;margin-bottom:20px;}
    .footerBtn{width:400px;height:40px;margin:20px auto;}
    .footerBtn1{width:240px;height:40px;font-size:18px;background:#0696fa;color:#fff;float:left;cursor: pointer;border:0;border-radius:6px;font-family: "微软雅黑"}
    .footerBtn2{width:140px;height:40px;font-size:18px;background:#fff;color:#0696fa;float:left;cursor: pointer;border:1px solid #0696fa;float:right;border-radius:6px;font-family: "微软雅黑"}
    .address input{width:205px;height: 40px;border:0;background: #fff;margin-left:40px;}
    .address em{display: block;width: 20px;height:20px; position: absolute;left: 220px;top:15px;cursor:pointer}
    .address em img{display: block;width: 100%;height: 100%;}
    .address{text-indent: 0;}
    .address .addressMain{
      position: absolute;
        left:30px;
        top:40px;
        width: 300px;
        height: 250px;
        border: 1px solid #dbe9ee;
        box-shadow: 1px 5px 7px #e6eff2;
        background: #fff;
        z-index: 20;
    }
    .addressMain .address-title{
        width: 100%;
        height: 40px;
        border-bottom:1px solid #dbe9ee;
        background: #f1f9fc;
    }
    .addressMain .pname{
        width: 149px;
        height: 100%;
        float: left;
        text-align: center;
        line-height: 40px;
        color: #666;
        cursor: pointer;
        border-right: 1px solid #dbe9ee;
    }
    .addressMain .cname{
        width: 149px;
        height: 100%;
        text-align: center;
        line-height: 40px;
        color: #666;
        float: left;
        cursor: pointer;
    }
    .addressMain .active{
        color: #0696fa;
        background: #fff;
        border-bottom: 1px solid #fff;
    }

    .address-content .city,.address-content .province{
        width: 100%;
        height: 100%;
        padding:15px;
        box-sizing: border-box;
    }
    .address-content .city ul{
        width: 100%;
        height: 100%;
    }
    .address-content .city li{
        float: left;
        margin: 8px;
        color: #333;
        font-size: 12px;
        cursor: pointer;
    }
    .address-content .province ul{
        width: 100%;
        height: 50px;
    }

    .address-content .province ul li{
        float: left;
        margin-right: 20px;
        margin-bottom: 4px;
        cursor: pointer;
        color: #333;
        font-size: 12px;
    }
    .address-content .province ul p{
        height: 45px;
        width: 50px;
        float: left;
        color: #333;
        font-size: 12px;

    }

    .oneTxte .dateMain{
        width: 164px;
        height: 206px;
       position: absolute;
        left: 30px;
        top: 40px;
        background: #fff;
        border: 1px solid #dbe9ee;
        box-shadow: 1px 5px 7px #e6eff2;
    }
    .oneTxte input{
        text-align: center;
    }
    .oneTxte .date2{
        position: absolute;
        left:300px;
        top: 40px;
    }
    .dateMain .date-title{
        width: 100%;
        height: 40px;
        background: #0696fa;
        text-align: center;
        line-height: 40px;
        position: relative;
        color: #fff !important;
    }
    .dateMain .date-title .date-left{
        position: absolute;
        left: 18px;
        top:15px;
        cursor: pointer;
    }
    .dateMain .date-title .date-right{
        position: absolute;
        right: 18px;
        top:15px;
        cursor: pointer;
    }
    .dateMain .date-content{
        width: 100%;
        height: 100%;
        padding: 20px 20px 0;
        box-sizing: border-box;
    }
    .dateMain .date-content li{
        float: left;
        width: 22px;
        height: 22px;
        text-align: center;
        line-height: 22px;
        margin:0 28px 13px 0;
        cursor: pointer;
        border-radius: 5px;
    }
    .dateMain .date-content li:hover{
        background: #0696fa;
        color: #fff;
    }
    .dateMain .date-content .lit{
        margin-right: 0;
    }
    .para-input{
        border:0;
        color:#666;
        height:45px;
    }
    #startDate,#endDate{
        height:100%;
        background:none;
    }
    .overbase-input{
        border:0;
    }
    #typeSelect{
        width:200px;
        height:100%;
        border:0;
        color:#666;
    }
    .layui-layer-content{
        margin-top:5px;
    }
    .baseTableNav{
        line-height: 60px;
        padding-left:30px;
        border: 1px solid #dbe9ee;
        font-size:20px;
        color:#333;
        border-bottom:0;
        font-weight:600;
    }
    .socialTitle{
        line-height: 60px;
        padding-left:30px;
        border: 1px solid #dbe9ee;
        font-size:20px;
        color:#333;
        border-bottom:0;
        font-weight:600;
        margin-top:20px;
    }

</style>
<body>
    <div class="salaset-title">
    <h2 id="title">社保设置</h2>
    <img class="topImg" src="#springUrl('/resource/img/ture.png')" alt="" id="closeDetailBtn" onclick="javascript:location.href = BASE_PATH+'/shebao/shebaoIndex.htm';">
    <div class="all">
        <table id="basic-table">
            <tr>
                <td class="oneTitle"><span>*</span>&nbsp;参保地区</td>
                <td class="oneCon address">
##                    <select id="citySelect" onchange="ShebaoExtend.cityChange()">
##                        <option value=''>请选择</option>
##                        #foreach($city in $cities)
##                            <option value="$!city.city" data-month="$!city.month" data-lastDate="$!city.lastDate" data-subdl="$!city.subdl">$!city.cname</option>
##                        #end
##                    </select>
                    <input type="text" id="citySelect1" value="" placeholder="请点击右边图标选择地区" disabled="disabled"/>
                    <input type="hidden"  id="citySelect" onchange="ShebaoExtend.cityChange()"/>
                    <em><img src="#springUrl('/resource/img/address.png')" alt=""></em>
                    <!--地区控件 -->
                    <div class="addressMain" style="display:none">
                        <div class="address-title">
                            <div class="pname active">省份</div>
                            <div class="cname">城市</div>
                        </div>
                        <div class="address-content">
                            <div class='province'>
                                <ul class='list1'>
                                    <p>A-G</p>
                                </ul>
                                <ul class='list2'>
                                    <p>H-K</p>
                                </ul>
                                <ul class='list3'>
                                    <p>L-S</p>
                                </ul>
                                <ul class='list4'>
                                    <p>T-Z</p>
                                </ul>
                            </div>
                            <div class="city" style="display: none">
                            </div>
                        </div>
                    </div>
                    <!--end -->
                </td>
            </tr>
            <tr>
                <td class="oneTitle"><span>*</span>&nbsp;缴纳类型</td>
                <td class="oneCon">
                    <select id="typeSelect" onchange="ShebaoExtend.typeChange()">
                        <option value='' style="color:#999;">请选择</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td class="oneTitle"><span>*</span>&nbsp;缴纳基数</td>
                <td>
                    <div style="float:left;" class="sit"><span style="padding-left:40px;">
                        <input class="para-input" type="input" name="base" placeholder="请输入缴纳基数" onchange="ShebaoExtend.calBaseMoney()" style="width:180px;"/>
                    </span>元</div>
                    <div style="float:left;padding-left:40px;" class="sit"><span id="base-maxmin-tips"></span></div>
                </td>
            </tr>
            <tr>
                <td class="oneTitle">是否补缴</td>
                <td class="oneImg">
                    <input class="para-input" id="isOver" name="isOver" type="checkbox" value="1" style="display: none;"/>
                    <img class="oneImg1" src="#springUrl('/resource/img/Switch-OFF.png')" data-isSelect="false" data-src2="#springUrl('/resource/img/Switch-ON.png')" alt="">
                </td>
            </tr>
            <tr id="month-tr" style="display: none;">
                <td class="oneTitle"><span>*</span>&nbsp;补缴月份</td>
                <td class="oneTxte">
                    <input type="text" id="startDate" class="over-input startDate" placeholder="请选择日期">-
                    <!--时间控件 -->
                    <div class="dateMain date1" style="display: none">
                        <div class="date-title">
                            <em class='date-left'>
                                <img src="#springUrl('/resource/img/date-left.png')">
                            </em>
                            <i>2015</i>
                            <em class='date-right'>
                                <img src="#springUrl('/resource/img/date-right.png')">
                            </em>
                        </div>
                        <div class="date-content">
                            <ul>
                                <li>01</li>
                                <li>02</li>
                                <li class='lit'>03</li>
                                <li>04</li>
                                <li>05</li>
                                <li class='lit'>06</li>
                                <li>07</li>
                                <li>08</li>
                                <li class='lit'>09</li>
                                <li>10</li>
                                <li>11</li>
                                <li class='lit'>12</li>

                            </ul>
                        </div>
                    </div>
                    <!--end -->
                    <input type="text" id="endDate" class="over-input endDate" placeholder="请选择日期">
                    <!--时间控件 -->
                    <div class="dateMain date2" style="display: none">
                        <div class="date-title">
                            <em class='date-left'>
                                <img src="#springUrl('/resource/img/date-left.png')">
                            </em>
                            <i>2015</i>
                            <em class='date-right'>
                                <img src="#springUrl('/resource/img/date-right.png')">
                            </em>
                        </div>
                        <div class="date-content">
                            <ul>
                                <li>01</li>
                                <li>02</li>
                                <li class='lit'>03</li>
                                <li>04</li>
                                <li>05</li>
                                <li class='lit'>06</li>
                                <li>07</li>
                                <li>08</li>
                                <li class='lit'>09</li>
                                <li>10</li>
                                <li>11</li>
                                <li class='lit'>12</li>

                            </ul>
                        </div>
                    </div>
                    <!--end -->
                    <span style="padding-left:100px;"></span>
                    <span id="over-month-tips"></span>
                    <span></span>
                </td>
            </tr>
        </table>
        <div class="part" style="display: none;">
            <span style="padding-left:20px;">温馨提示：缴纳月份：</span>
            <span id="jryf">-</span>
            <span style="padding-left:40px;">社保费用：</span>
            <span id="sbfy">0</span>
            <span>元/月</span>
            <span style="padding-left:40px;">社保补缴费用：</span>
            <span id="sbbjfy">0</span>
            <span>元</span>
            <span style="padding-left:40px;">本账单月社保费用总额：</span>
            <span id="byzdze">0</span>
            <span>元</span>
        </div>
        <div class="baseTableNav">社保费用计算详情</div>
        <table id="baseTable" style="text-align: center;color:#666;">
            <thead class="toCon">
                <td>险种</td>
                <td>基数（元）</td>
                <td>单位比例</td>
                <td>单位费用（元）</td>
                <td>个人比例</td>
                <td>个人费用（元）</td>
            </thead>
            <tbody>
            <tr><td colspan='6'>暂无数据</td></tr>
            </tbody>
        </table>
        <div class="socialTitle">首月缴纳费用明细</div>
        <table class='overTable' style='text-align: center;color:#666;'>
            <thead class='toCon'>
                <td>续费账单月</td>
                <td>缴纳说明</td>
                <td>单位费用（元）</td>
                <td>个人费用（元）</td>
                <td>小计（元）</td>
            </thead>
            <tbody class="add-tbody">
                <tr><td colspan='5'>暂无数据</td></tr>
            </tbody>
            <tbody class="over-tbody">

            </tbody>
            <tbody class="sum-tbody">

            </tbody>
        </table>
        <div class="footer">
            <div class="footerBtn">
                <input class="footerBtn1" type="button" onclick="ShebaoExtend.submit()" value="确认">
                <input class="footerBtn2" type="button" value="取消" onclick="javascript:location.href = BASE_PATH+'/shebao/shebaoIndex.htm';">
            </div>
        </div>
    </div>
</div>
<script>
    ShebaoExtend = {
        types:{},
        joinDatas:{},
        oneImagClick : function(){
            var src1 = $(this).attr("src");
            var src2 = $(this).data("src2");
            $(this).attr("src", src2);
            $(this).data("src2", src1);
            var isSelect = $(this).data("isSelect");

            if(!isSelect) {
                $("#isOver").attr("checked", true);
                $("#month-tr").show();
            }else{
                $("#isOver").attr("checked", false);
                $("#month-tr").hide();
            }

            ShebaoExtend.onIsOverChanged();

            $(this).data("isSelect", !isSelect);
        },
        init:function(){
            $(".para-input").attr("disabled", true);
            $(".over-input").attr("disabled", true);
        },
        cityChange : function(){
            var cityCode = $("#citySelect").val();
            ShebaoExtend.reset();
            $("#typeSelect").html("<option value=''>请选择</option>");
            ShebaoExtend.onTypeSelected(null);
            ShebaoExtend.types={};
            if(cityCode){
//                var option = $("#citySelect").find("option:selected");
                $("#jryf").html($("#citySelect").data("month"));
                $.ajax({
                    type: 'post',
                    url: BASE_PATH + '/shebao/cityBasic.htm',
                    data: {"cityCode" : cityCode},
                    dataType: 'json',
                    success: function (data) {
                        $.each(data.ins, function(index, data) {
                            var opt = $("<option>");
                            $(opt).html(data.desc || data.name);
                            $(opt).val(data.type);
                            $("#typeSelect").append(opt)
                            ShebaoExtend.types[data.type] = data;
                        });
                    }
                });
            }else{
                $("#jryf").html("-");
            }
        },
        typeChange:function(){
            var type = $("#typeSelect").val();
            ShebaoExtend.reset();
            if(type == ""){
                $(".para-input").attr("disabled", true);
                $(".over-input").attr("disabled", true);
                $(".oneImg1").unbind("click");//禁止点击
                return;
            }
            $(".oneImg1").unbind("click").bind("click", ShebaoExtend.oneImagClick);
            $("input[name=base]").data("max", ShebaoExtend.types[type].max);
            $("input[name=base]").data("min", ShebaoExtend.types[type].min);
            ShebaoExtend.onTypeSelected(ShebaoExtend.types[type]);
        },
        onTypeSelected:function(typeData) {
            if(typeData) {
                $(".para-input").attr("disabled", false);
                $("#base-maxmin-tips").html("基数范围：" + typeData.min + " 至 " + typeData.max);
                $("#endDate").attr("disabled", true);
                if(typeData.obmonth && typeData.oemonth) {
                    $("#startDate").attr("disabled", false);
                    $("#endDate").val(typeData.oemonth.replace("-", ""));
                    $("#over-month-tips").html("可补缴月份：" + typeData.obmonth + " 至 " + typeData.oemonth);
                }else{
                    $("#startDate").attr("disabled", true);
                    $("#isOver").attr("disabled", true);
                    $("#over-month-tips").html("当前无可补缴月份");
                }
            }else{
                $(".para-input").attr("disabled", true);
                $("#base-maxmin-tips").html("");
                $("#over-month-tips").html("");
            }
        },
        onIsOverChanged : function(){
            var isOver = $("#isOver:checked").val();
            ShebaoExtend.resetOver();
        },
        validateMoney:function(input){
            var val = $(input).val();
            if(!isMoney(val)) {
                layer.tips('请输入基数', $(input));
                return false;
            }
            val = parseFloat(val);
            var max = $(input).data("max");
            if(max) {
                if(val > parseFloat(max)) {
//                    layer.tips('基数最大值为' + max, $(input));
                    layer.tips('请输入正确的基数', $(input));
                    return false;
                }
            }
            var min = $(input).data("min");
            if(min) {
                if(val < parseFloat(min)) {
//                    layer.tips('基数最小值为' + min, $(input));
                    layer.tips('请输入正确的基数', $(input));
                    return false;
                }
            }
            return true;
        },
        updateSum:function(){
            var v1 = 0;
            var v2 = 0;
            var v3 = 0;

            $(".overTable tbody[class='add-tbody'] tr, .overTable tbody[class='over-tbody'] tr").find("td:eq(2)").each(function(index, data){
                var text = $(data).text();
                if(!isNaN(text)) {
                    v1 += parseFloat(text);
                }
            });

            $(".overTable tbody[class='add-tbody'] tr, .overTable tbody[class='over-tbody'] tr").find("td:eq(3)").each(function(index, data){
                var text = $(data).text();
                if(!isNaN(text)) {
                    v2 += parseFloat(text);
                }
            });

            $(".overTable tbody[class='add-tbody'] tr, .overTable tbody[class='over-tbody'] tr").find("td:eq(4)").each(function(index, data){
                var text = $(data).text();
                if(!isNaN(text)) {
                    v3 += parseFloat(text);
                }
            });

            var tr2 = $("<tr>");
            tr2.append("<td>总计</td>")
            tr2.append("<td></td>")
            tr2.append("<td>" + v1.toFixed(2)  + "</td>")
            tr2.append("<td>" + v2.toFixed(2)  + "</td>")
            tr2.append("<td>" + v3.toFixed(2) + "</td>")
            $(".sum-tbody").html(tr2);
        },
        calBaseMoney:function(){
            if(ShebaoExtend.validateMoney($("input[name=base]"))) {
                $("#baseTable tbody").empty();
                var result = ShebaoExtend.calInc($("#citySelect").val(), parseFloat($("input[name=base]").val()), $("#typeSelect").val());
                $.each(result.rows, function(index, data){
                    var tr = $("<tr>");
                    tr.append("<td>" + data.name + "</td>")
                    tr.append("<td>" + data.rowBase + "</td>")
                    tr.append("<td>" + data.orgprop + "</td>")
                    tr.append("<td>" + parseFloat(data.orgbase).toFixed(2) + "</td>")
                    tr.append("<td>" + data.empprop + "</td>")
                    tr.append("<td>" + parseFloat(data.empbase).toFixed(2) + "</td>")
                    $("#baseTable tbody").append(tr)
                })

//                var tr = $("<tr>");
//                tr.append("<td>总计</td>")
//                tr.append("<td colspan='3'>" + parseFloat(result.sum.orgsum).toFixed(2) + "元" + "<span>（单位承担费用）</span>" + "</td>")
//                tr.append("<td colspan='2'>" + parseFloat(result.sum.empsum).toFixed(2) + "元" + "<span>（个人承担费用）</span>" +"</td>")
//                $("#baseTable tbody").append(tr)
                $("#sbfy").html(parseFloat(parseFloat(result.sum.orgsum) + parseFloat(result.sum.empsum)).toFixed(2));
                ShebaoExtend.updateByzdze();

                var tr2 = $("<tr>");
                tr2.append("<td>" + $("#jryf").text() + "</td>")
                tr2.append("<td>增员" + $("#jryf").text() + "</td>")
                tr2.append("<td>" + parseFloat(result.sum.orgsum).toFixed(2)  + "</td>")
                tr2.append("<td>" + parseFloat(result.sum.empsum).toFixed(2)  + "</td>")
                tr2.append("<td>" + parseFloat(parseFloat(result.sum.orgsum) + parseFloat(result.sum.empsum)).toFixed(2) + "</td>")
                $(".add-tbody").html(tr2);
            }else{
                $(".add-tbody").empty();
            }
            ShebaoExtend.updateSum();

        },
        calOverMoney:function(){
            var isok = true;
            ShebaoExtend.clearOverTable();
            $.each($(".overbase-input"), function(index, input){
                if(!ShebaoExtend.validateMoney(input)){
                    isok = false;
                    return false;
                }
            })
            if(isok == false){
                return false;
            }

            var orgoversum = 0;
            var empoversum = 0;
            var overCalResult = ShebaoExtend.calOver();

            $.each(overCalResult, function(index, data) {
                var tbody = $(".over-tbody");
                var tr = $("<tr>");
                tr.append("<td>" + $("#jryf").text() + "</td>")
                tr.append("<td>补缴" + data.month + "</td>")
                tr.append("<td>" + parseFloat(data.orgSum).toFixed(2)  + "</td>")
                tr.append("<td>" + parseFloat(data.empSum).toFixed(2) + "</td>")
                tr.append("<td>" + parseFloat(parseFloat(data.empSum) + parseFloat(data.orgSum)).toFixed(2) + "</td>")
                orgoversum += data.orgSum;
                empoversum += data.empSum;
                tbody.append(tr)
            })
            ShebaoExtend.updateSum();
        },
        calInc:function(joinCity, base, type){
            var result = {};
            $.ajax({
                type: 'post',
                url: BASE_PATH + '/shebao/calBySbt.htm',
                data: {"base": base, "requireType": 1, "type": type, "joinCity": joinCity},
                dataType: 'json',
                async: false,
                success: function (data) {
                    if(data.success){
                        result["rows"] = data.data.rows;
                        result["sum"] = {"orgsum":data.data.orgSum, "empsum":data.data.empSum};
                    }else{
                        showInfo("计算失败", '提示', function(){});
                    }
                }
            });
            return result;
        },
        calOver:function(){
            var result = {};
            var json = {};
            json.cityCode = $("#citySelect").val();
            json.type = $("#typeSelect").val();
            json.shebaoType = 1;
            json.overOrders = [];
            $.each($(".overbase-input"), function(index, input){
                var months = isNaN($(input).data("months")) ? $(input).data("months").split(",") : [$(input).data("months")];
                $.each(months, function(index, m) {
                    var overOrder ={};
                    overOrder.month = m;
                    overOrder.base = $(input).val();
                    json.overOrders.push(overOrder);
                })
            })

            $.ajax({
                type: 'post',
                url: BASE_PATH + '/shebao/calOverBySbt.htm',
                data: JSON.stringify(json),
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                async: false,
                success: function (data) {
                    if(data.success) {
                        result = data.data;
                    }else{
                        showWarning(data.message);
                    }
                }
            });
            return result;
        },
        onOverDateChange :function(){
            $("#basic-table .over-input-tr").remove();
            ShebaoExtend.clearOverTable();
            ShebaoExtend.joinDatas = {};
            if(ShebaoExtend.validateOverDate()) {
                var startDate = $("#startDate").val();
                var endDate = $("#endDate").val();
                var cityCode = $("#citySelect").val();
                var type = $("#typeSelect").val();
                $.ajax({
                    type: 'post',
                    url: BASE_PATH + '/shebao/getHistoryBasic.htm',
                    data: {"cityCode" : cityCode,"startMonth" : startDate,"endMonth" : endDate},
                    dataType: 'json',
                    error:function(){
                        $("#basic-table").html("<tr class='over-input-tr'><td colspan='2'>暂无基数</td></tr>");
                    },
                    success: function (data) {
                        var overDatas = [];
                        $.each(data.data, function(index, item){
                            var overData = {};
                            overData.month = item.month;
                            $.each(item.ins, function(index2, ins2){
                                if(ins2.type == type) {
                                    overData.inc = ins2.inc;
                                    overData.min = ins2.min;
                                    overData.max = ins2.max;
                                    return false;
                                }
                            })
                            overDatas.push(overData);
                        })
                        var joinDatas = [];
                        var joinData = null;
                        $.each(overDatas, function(index, data) {
                            if(joinData == null) {
                                joinData = {};
                                joinData.min =data.min;
                                joinData.max =data.max;
                                joinData.inc = data.inc;
                                joinData.months = [];
                            }

                            if(joinData.min == data.min && joinData.max == data.max) {
                                joinData.months.push(data.month);
                            }else {
                                joinDatas.push($.extend(true, {}, joinData));
                                joinData.min =data.min;
                                joinData.max =data.max;
                                joinData.inc = data.inc;
                                joinData.months = [data.month];
                            }
                        })
                        joinDatas.push(joinData);

                        if(joinDatas) {
                            $.each(joinDatas, function(index, joinData){
                                var monthsjoin = joinData.months.join(",");
                                var tr = $("<tr class='over-input-tr'>");
                                tr.append($("<td class='oneTitle'><span>*</span>&nbsp;补缴基数" + (index + 1) + "</td>"));
                                var td2 = $("<td>");
                                td2.append("<span style='padding-left:40px;color:#333;'><input placeholder='请输入补缴基数' class='overbase-input' onchange='ShebaoExtend.calOverMoney()' data-months='"+monthsjoin+"' data-max='" + joinData.max + "' data-min='" + joinData.min + "'/></span>")
                                ShebaoExtend.joinDatas[monthsjoin] = joinData.inc;
                                tr.append(td2);
                                var monthstr="";
                                if(joinData.months.length > 1) {
                                    monthstr = joinData.months[0] + " - " + joinData.months[joinData.months.length - 1];
                                }else{
                                    monthstr = joinData.months[0];
                                }
                                td2.append("<span style='padding-left:200px;'>[" + monthstr + "]</span>");
                                td2.append("<span>基数范围：" + joinData.min + " - " + joinData.max + "</span>");
                                $("#basic-table").append(tr);
                            })

                        }else{
                            $("#basic-table").append("<tr class='over-input-tr'><td colspan='2'>暂无基数</td></tr>");
                        }
                    }
                });
            }else{
                ShebaoExtend.clearOverTable()
            }
        },
        validateOverDate : function(){
            var startDate = $("#startDate").val();
            var endDate = $("#endDate").val();
            var obmonth = ShebaoExtend.types[$("#typeSelect").val()].obmonth;
            var oemonth = ShebaoExtend.types[$("#typeSelect").val()].oemonth;

            if(!obmonth) {
                layer.tips('当前无可补缴月份', $("#startDate"));
                return false;
            }

            if(!oemonth) {
                layer.tips('当前无可补缴月份', $("#endDate"));
                return false;
            }

            obmonth = obmonth.replace("-", "");
            oemonth = oemonth.replace("-", "");
            obmonth = parseInt(obmonth);
            oemonth = parseInt(oemonth);
            if(isNaN(startDate)) {
                layer.tips('请输入正确的补缴开始时间', $("#startDate"));
                return false;
            }

            if(isNaN(endDate)) {
                layer.tips('请输入正确的补缴结束时间', $("#endDate"));
                return false;
            }

            if(startDate) {
                if(startDate > oemonth || startDate < obmonth) {
                    layer.tips('请输入补缴范围内的时间', $("#startDate"));
                    return false;
                }
            }else{
                layer.tips('请选择补缴月份', $("#startDate"));
                return false;
            }
            if(endDate) {
                if(endDate > oemonth || endDate < obmonth) {
                    layer.tips('请输入补缴范围内的时间', $("#endDate"));
                    return false;
                }
            }else{
                layer.tips('请输入补缴结束时间', $("#endDate"));
                return false;
            }

            if(endDate < startDate) {
                layer.tips('开始时间不能大于结束时间', $("#startDate"));
                return false;
            }

            return true;
        },
        updateByzdze:function(){
            var sbfy = $("#sbfy").html();
            var sbbjfy = $("#sbbjfy").html();
            var sum = parseFloat(sbfy) + parseFloat(sbbjfy);
            $("#byzdze").html(sum);
        },
        submit:function(){
            if(!$("#citySelect").val()) {
                layer.tips('请选择参保地区', $("#citySelect1"),{tips: 2});
                return false;
            }
            if(!$("#typeSelect").val()) {
                layer.tips('请选择缴纳类型', $("#typeSelect"));
                return false;
            }

            if(!ShebaoExtend.validateMoney($("input[name=base]"))) {
                return false;
            }

            var obmonth = ShebaoExtend.types[$("#typeSelect").val()].obmonth;
            var oemonth = ShebaoExtend.types[$("#typeSelect").val()].oemonth;
            var isOver = $("#isOver:checked").val();
            if(isOver === "1" && obmonth && oemonth) {//补缴
                if (!ShebaoExtend.validateOverDate()) {
                    return false;
                }else{

                    var isok = true;
                    $.each($(".overbase-input"), function(index, input){
                        if(!ShebaoExtend.validateMoney(input)){
                            isok = false;
                            return false;
                        }
                    })
                    if(isok == false)
                        return false;

                }
            }

            var json = {};
            json.cityCode = $("#citySelect").val();
            json.type = $("#typeSelect").val();
            json.base = $("input[name=base]").val();
            json.isOver = isOver;
            json.customerId = '$!{customer.customerId}';
            if(isOver == "1") {
                json.overOrders = [];
                $.each($(".overbase-input"), function(index, input){
                    var months = isNaN($(input).data("months")) ? $(input).data("months").split(",") : [$(input).data("months")];
                    $.each(months, function(index, m) {
                        var overOrder ={};
                        overOrder.month = m;
                        overOrder.base = $(input).val();
                        json.overOrders.push(overOrder);
                    })
                })
            }

            layer.load();
            $.ajax({
                type: 'post',
                url: BASE_PATH + '/shebao/jrsb.htm',
                data: JSON.stringify(json),
                contentType: "application/json; charset=utf-8",
                dataType: 'json',
                success: function (data) {
                    layer.closeAll('loading');
                    if(data.success) {
                        showInfo("设置成功", '提示', function(){
//                            history.go(-1);
                            location.href = BASE_PATH+"/shebao/shebaoIndex.htm";
                        });
                    }else{
                        showWarning(data.message);
                    }
                },
                error: function(){
                    layer.closeAll('loading');
                }
            });

            return true;

        },
        reset:function(){
            ShebaoExtend.resetBase();
            ShebaoExtend.resetOver();
        },
        resetBase:function(){
            $("#month-tr").hide();
            $("input[name=base]").val("");
            $("#isOver").attr("checked", false);
            //恢复选择框为默认图片
            $(".oneImg1").attr("src", "#springUrl('/resource/img/Switch-OFF.png')");
            $(".oneImg1").data("src2", "#springUrl('/resource/img/Switch-ON.png')");
            $(".oneImg1").data("isSelect", false);

            $("#sbfy").html(0);
            $(".add-tbody").empty();
            ShebaoExtend.clearOverTable();
            ShebaoExtend.updateSum();
        },
        resetOver:function(){
//            $("#isOver").attr("checked", false);
//            $("#month-tr").hide();

            $("#startDate").val("");
            $(".over-input-tr").remove();
            ShebaoExtend.joinDatas = {};
            ShebaoExtend.clearOverTable();
            ShebaoExtend.updateSum();
        },
        clearOverTable:function(){
            $(".over-tbody").empty();
            ShebaoExtend.updateByzdze();
        }

    }

    $(function(){
        ShebaoExtend.init();
    })





    //初始化
    btProvice()

    $('.pname').on('click',function(){
        $(this).addClass('active').siblings().removeClass('active')
        $('.province').show();
        $('.city').hide();
    })

    //获取省份
    function btProvice(){
        $.ajax({
            url:BASE_PATH +'/shebao/getCities.htm',
            type:'post',
            success:function(data){
                data=data.data;
                console.log(data.length)
                var Arr1=[];
                var Arr2=[];
                var Arr3=[];
                var Arr4=[];
                var that1=this[i]
                for (var i = 0; i < data.length; i++) {
                    var str=data[i].prov;

                    var code=str.charCodeAt()
                    if(code>=97&&code<=103){
                        Arr1.push(data[i].pname)

                    }else if(code>=104&&code<=107){
                        Arr2.push(data[i].pname)
                    }else if(code>=108&&code<=115){
                        Arr3.push(data[i].pname)
                    }else{
                        Arr4.push(data[i].pname)
                    }


                };
                console.log(getArr(Arr1))
                function getArr(Arr){
                    var  newArr=distinctArray(Arr);
                    return newArr= newArr.sort(
                            function compareFunction(a,b){
                                return a.localeCompare(b);
                            }
                    );
                }

                for (var j = 0; j < getArr(Arr1).length; j++) {
                    $('.province .list1').append("<li>"+getArr(Arr1)[j]+"</li>")
                };
                for (var j = 0; j < getArr(Arr2).length; j++) {
                    $('.province .list2').append("<li>"+getArr(Arr2)[j]+"</li>")
                };
                for (var j = 0; j < getArr(Arr3).length; j++) {
                    $('.province .list3').append("<li>"+getArr(Arr3)[j]+"</li>")
                };
                for (var j = 0; j < getArr(Arr4).length; j++) {
                    $('.province .list4').append("<li>"+getArr(Arr4)[j]+"</li>")
                };

                btCity()
            }


        })
    }

    // 获取城市
    function btCity(){

        $('.province li').on('click',function(){
            $('.city').html('')
            $(this).css('color','#0696fa').siblings().css('color','#333');
            $(this).parent().siblings().find('li').css('color','#333')
            $('.pname').removeClass('active');
            $('.cname').addClass('active')
            $('.province').hide();
            $('.city').show();
            var that=$(this)
            $.ajax({
                url:BASE_PATH +'/shebao/getCities.htm',
                type:'post',
                success:function(data){
                    data=data.data;
                    for (var i = 0; i < data.length; i++) {
                        if(data[i].pname==that.html()){
                            $('.city').append("<li data="+data[i].city+" data-month="+data[i].month +">"+data[i].cname+"</li>")
                        }

                    }
                    GetCity()
                }

            })
        })

    }

    // 去重
    function distinctArray(arr){
        var obj={},temp=[];
        for(var i=0;i<arr.length;i++){
            if(!obj[arr[i]]){
                temp.push(arr[i]);
                obj[arr[i]] =true;
            }
        }
        return temp;
    }


    // 点击城市
    function GetCity(){
        $('.city li').unbind('click').bind('click',function(){
            $('.address input').val($(this).html())
            $('#citySelect').val($(this).attr('data'))
            $('#citySelect').data("month",$(this).data('month'))

            console.log($(this).html()+'+'+$(this).attr('data'))
            $('.addressMain').hide();
            ShebaoExtend.cityChange();

        })
//        $('td').on('click',function(){
//            $('.addressMain').hide();
//        })


    }
    //
    $('.address em').on('click',function(e){
        $('.addressMain').show();
        e.stopPropagation()
        GetCity()
    })

    $(document).on('click',function(){
        $('.addressMain').hide()
    })
    $('.addressMain').on('click',function(e){
        e.stopPropagation()
    })




    //  ...........时间控件
    // 年份变化(减)
    $('.date-left').on('click',function(){

        var timer=$(this).parent().find('i').text()
        timer--
        // if(timer<2016){
        // 	// judYear()
        // 	return
        // }else{
        getNowDate()
        $(this).parent().find('i').text(timer)
        // }
        judYear()

    });
    // 年份变化(加)
    $('.date-right').on('click',function(){
        getNowDate()
        var timer=$(this).parent().find('i').text()
        timer++
        $(this).parent().find('i').text(timer)
        judYear()
    })

    // 月份变化
    $('.date-content li').on('click',function(){
        $(this).css({'background':'#0696fa','color':'#fff'}).siblings().css({'background':'#fff','color':'#333'})

    });


    // 初始化
    getNowDate()
    $('.date-title i').html(initY)


    // 获取当前时间
    function getNowDate(){
        nowdate = new Date();
        initM=parseInt(nowdate.getMonth()+"")+1; // .....当前月
        initY=parseInt((nowdate.getFullYear())); // .....当前年
        outM=Add(initM);
        var obj=$('.date-content li')
        for (var i = 0; i < obj.length; i++) {
            console.log(obj[i].innerHTML)
            if(obj[i].innerHTML==outM ){
                obj[i].style.border='1px solid #0696fa';
//                obj[i].style.color='#0696fa';
            };
        }
    }

    // 判断是否是当前的年份
    function judYear(){
        if($('.date-title i').html()!=initY){
            $('.date-content li').css({'border':'0','color':'#333','background':'#fff'})
            // $('.date-content li:first').css({'background':'#0696fa','color':'#fff'});


        }else{
//            $('.date-content li').css({'background':'#fff','color':'#333'});
        }

    }

    // 个位数加零
    function Add(n){
        if(n<10){
            return '0'+n ;
        }else{
            return n;
        }
    }

    //开始时间

$('.startDate').on('click',function(e){
    getNowDate()
    $('.date-title i').html(initY)
    e.stopPropagation()
    $('.date1').show();
    $('.date2').hide();
    $('.date1 .date-content li').unbind('click').bind('click',function(){
        var moth=$(this).html();
        console.log(moth)
        var year=$('.date1').find('i').html()
        $('.startDate').val(year+moth);
        ShebaoExtend.onOverDateChange()
        $('.date1').hide()


    });

})

    $(document).on('click',function(){
        $('.date1').hide()
    })
    $('.date1').on('click',function(e){
        e.stopPropagation()
    })

    //结束时间

    $('.endDate').on('click',function(e){
        getNowDate()
        $('.date-title i').html(initY)
        e.stopPropagation()
        $('.date2').show();
        $('.date1').hide();
        $('.date2 .date-content li').unbind('click').bind('click',function(){
            var moth=$(this).html();
            console.log(moth)
            var year=$('.date2').find('i').html()
            $('.endDate').val(year+moth);
            ShebaoExtend.onOverDateChange()
            $('.date2').hide()


        });

    })

    $(document).on('click',function(){
        $('.date2').hide()
    })
    $('.date2').on('click',function(e){
        e.stopPropagation()
    })

    //格式化金额，不带千位符
    function formatCurrency(s, n) {
        var t;
        t = s;
        if ($.isNumeric(t)){
            t = parseFloat(t).toFixed(n);
        }

        return t;
    }
</script>
</body>
</html>