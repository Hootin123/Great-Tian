<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xtr.core.persistence.reader.company.CompanyDepsReaderMapper">
    <resultMap id="BaseResultMap" type="com.xtr.api.domain.company.CompanyDepsBean">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="dep_id" property="depId" jdbcType="BIGINT"/>
        <result column="dep_company_id" property="depCompanyId" jdbcType="BIGINT"/>
        <result column="dep_parent_id" property="depParentId" jdbcType="BIGINT"/>
        <result column="dep_name" property="depName" jdbcType="VARCHAR"/>
        <result column="dep_number" property="depNumber" jdbcType="VARCHAR"/>
        <result column="dep_type" property="depType" jdbcType="INTEGER"/>
        <result column="dep_salary_day" property="depSalaryDay" jdbcType="INTEGER"/>
        <result column="dep_sign" property="depSign" jdbcType="INTEGER"/>
        <result column="dep_salary_sumdays" property="depSalarySumdays" jdbcType="INTEGER"/>
        <result column="dep_updateuser_date" property="depUpdateuserDate" jdbcType="INTEGER"/>
        <result column="dep_edit_member" property="depEditMember" jdbcType="BIGINT"/>
        <result column="dep_edit_time" property="depEditTime" jdbcType="TIMESTAMP"/>
        <result column="company_id" property="companyId" jdbcType="BIGINT"/>
        <result column="dep_level" property="depLevel" jdbcType="INTEGER"/>
        <result column="dep_cust_count" property="depCustCount" jdbcType="INTEGER"/>
        <result column="dep_leader" property="depLeader" jdbcType="BIGINT"/>
        <result column="delflag" property="delflag" jdbcType="INTEGER"/>
    </resultMap>

    <resultMap id="CompanyResultMap" type="com.xtr.api.dto.company.CompanysDto">
        <id column="dep_id" property="depId" jdbcType="BIGINT"/>
        <result column="dep_name" property="depName" jdbcType="VARCHAR"/>
        <result column="company_id" property="companyId" jdbcType="BIGINT"/>
        <result column="dep_parent_id" property="depParentId" jdbcType="BIGINT"/>
        <result column="company_name" property="companyName" jdbcType="VARCHAR"/>
    </resultMap>

    <sql id="Base_Column_List">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        dep_id, dep_company_id, dep_parent_id, dep_name, dep_number, dep_type, dep_salary_day,
        dep_sign, dep_salary_sumdays, dep_updateuser_date, dep_edit_member, dep_edit_time,
        company_id, dep_level, dep_cust_count, dep_leader, delflag
    </sql>
    <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select
        <include refid="Base_Column_List"/>
        from company_deps
        where dep_id = #{depId,jdbcType=BIGINT}
    </select>

    <!-- 根据公司名称验证该公司是否存在-->
    <select id="checkDeptByName" resultMap="BaseResultMap">
      SELECT dep_id,dep_name from company_deps
      WHERE  dep_name = #{deptName,jdbcType=VARCHAR}
      AND dep_company_id = #{depCompanyId,jdbcType=BIGINT}
    </select>

    <!-- 根据企业主键获取部门信息-->
    <select id="getCompanyTree" resultMap="CompanyResultMap" parameterType="java.lang.Long">
        SELECT DISTINCT
          companys.company_id,
          companys.company_name,
          dept.dep_id,
          dept.dep_parent_id,
          dept.dep_name
        FROM companys
          LEFT JOIN company_deps dept
            ON dept.dep_company_id = companys.company_id
        WHERE dept.delflag = 0 and companys.company_id = #{companyId,jdbcType=BIGINT};
    </select>

    <select id="selectBaseDept" resultMap="BaseResultMap" parameterType="java.lang.Long">
        SELECT
        <include refid="Base_Column_List"/>
        from company_deps dept
        where
        dept.dep_parent_id is null
        and dept.delflag = 0
        and dept.dep_company_id = #{companyId,jdbcType=BIGINT};
    </select>

    <select id="selectChildren" resultMap="BaseResultMap" parameterType="java.lang.Long">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        company_deps dept
        WHERE
        dept.dep_parent_id = #{depId,jdbcType=BIGINT}
        AND dept.delflag = 0
    </select>

    <select id="selectAllDeptByCompanyId" resultMap="BaseResultMap" parameterType="java.lang.Long">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        company_deps dept
        WHERE
        dept.dep_company_id = #{companyId,jdbcType=BIGINT}
        AND dept.delflag = 0
    </select>

    <select id="selectByIds" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM company_deps where delflag = 0 and dep_id in
        <foreach item="item" index="index" collection="array" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <!-- 根据部门名称模糊查询部门信息-->
    <select id="selectByDeptName" resultMap="BaseResultMap">
        <bind name="pattern" value="'%' + _parameter.deptName + '%'" />
      SELECT dep_id,dep_name from company_deps
      where dep_company_id = #{companyId,jdbcType=BIGINT}
      and dep_name like #{pattern}
    </select>


    <!-- 根据公司社保订单号查询包含员工所属的部门清单-->
    <select id="getDepsTreeByCompanyShebaoId" resultMap="CompanyResultMap">
        SELECT distinct c.dep_id,c.dep_name,c.dep_parent_id,
        d.company_id,d.company_name
        from customer_shebao_order a
        left join customers_station b
        on a.customer_id = b.station_customer_id
        left join company_deps c
        on b.station_dept_id = c.dep_id
        left join companys d
        on c.dep_company_id = d.company_id
        where c.dep_id is not null and a.company_shebao_order_id = #{companyShebaoOrderId}
        and a.sbt_status!=2 and a.sbt_status!=3
    </select>

    <!-- 根据公司名称验证名称是否已经存在-->
    <select id="checkRepeatDeptByName" resultType="int">
        SELECT count(1) from company_deps
        WHERE  dep_name = #{depName,jdbcType=VARCHAR}
        AND dep_company_id = #{depCompanyId,jdbcType=BIGINT}
        <if test="depParentId != null ">
            and dep_parent_id=#{depParentId,jdbcType=INTEGER}
        </if>
        <if test="depParentId == null ">
            and dep_level=1
        </if>
    </select>
</mapper>