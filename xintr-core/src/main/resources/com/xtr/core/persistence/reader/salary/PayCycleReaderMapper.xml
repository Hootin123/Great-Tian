<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xtr.core.persistence.reader.salary.PayCycleReaderMapper">
    <resultMap id="BaseResultMap" type="com.xtr.api.domain.salary.PayCycleBean">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="company_id" property="companyId" jdbcType="BIGINT"/>
        <result column="is_generate_payroll" property="isGeneratePayroll" jdbcType="INTEGER"/>
        <result column="current_pay_cycle" property="currentPayCycle" jdbcType="VARCHAR"/>
        <result column="start_date" property="startDate" jdbcType="TIMESTAMP"/>
        <result column="end_date" property="endDate" jdbcType="TIMESTAMP"/>
        <result column="year" property="year" jdbcType="VARCHAR"/>
        <result column="month" property="month" jdbcType="VARCHAR"/>
        <result column="is_pay_off" property="isPayOff" jdbcType="INTEGER"/>
        <result column="approval_state" property="approvalState" jdbcType="INTEGER"/>
        <result column="labor_cost" property="laborCost" jdbcType="DECIMAL"/>
        <result column="total_wages" property="totalWages" jdbcType="DECIMAL"/>
        <result column="people_number" property="peopleNumber" jdbcType="INTEGER"/>
        <result column="pay_day" property="payDay" jdbcType="TIMESTAMP"/>
        <result column="pretax_payroll" property="pretaxPayroll" jdbcType="DECIMAL"/>
        <result column="social_security_fund" property="socialSecurityFund" jdbcType="DECIMAL"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
    </resultMap>

    <resultMap id="BaseResultDtoMap" type="com.xtr.api.dto.salary.PayCycleDto" extends="BaseResultMap">
        <result column="excel_title" property="excelTitle" jdbcType="VARCHAR"/>
        <result column="type" property="type" jdbcType="VARCHAR"/>
    </resultMap>
    <sql id="Base_Column_List">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        pay_cycle.id, pay_cycle.company_id, pay_cycle.is_generate_payroll,
        pay_cycle.current_pay_cycle,pay_cycle.start_date,pay_cycle.end_date,pay_cycle.year,pay_cycle.month,
        pay_cycle.is_pay_off,pay_cycle.approval_state,pay_cycle.labor_cost,pay_cycle.total_wages,
        pay_cycle.pay_day,pay_cycle.people_number,pay_cycle.create_time,pay_cycle.pretax_payroll,
        pay_cycle.social_security_fund
    </sql>
    <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select
        <include refid="Base_Column_List"/>
        from pay_cycle
        where id = #{id,jdbcType=BIGINT}
    </select>

    <!-- 根据公司id获取计薪周期-->
    <select id="selectByCompanyId" resultMap="BaseResultMap" parameterType="java.lang.Long">
        select
        <include refid="Base_Column_List"/>
        from pay_cycle
        where company_id = #{companyId,jdbcType=BIGINT}
        ORDER BY CONVERT(pay_cycle.year, SIGNED) desc ,CONVERT(pay_cycle.month, SIGNED) desc
        limit 1
    </select>

    <!-- 根据公司id获取计薪周期-->
    <select id="selectByCompanyIdAndDate" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        pay_cycle
        WHERE
        DATE_FORMAT(start_date, '%Y-%m-%d') <![CDATA[<=]]> #{date}
        AND DATE_FORMAT(end_date, '%Y-%m-%d') > #{date}
        AND company_id = #{companyId}
    </select>

    <!-- 获取未生成工资单的计薪周期-->
    <select id="selectPayCycle" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        pay_cycle
        WHERE is_generate_payroll = 0
    </select>

    <!-- 获取未发工资的计薪周期-->
    <select id="selectPayCycleSalary" resultMap="BaseResultMap" parameterType="java.lang.Long">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        pay_cycle
        WHERE approval_state = 1
        and is_pay_off = 1
    </select>

    <!--根据公司id获取年度-->
    <select id="selectYearByCompanyId" resultMap="BaseResultMap" parameterType="java.lang.Long">
        SELECT year FROM
        pay_cycle
        WHERE  company_id = #{companyId,jdbcType=BIGINT}
        and approval_state = 1
    </select>

    <!-- 根据公司id和年度查询工资单-->
    <select id="selectByCompanyIdAndYear" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        pay_cycle
        WHERE approval_state = 1
        and company_id = #{companyId,jdbcType=BIGINT}
        and year = #{year,jdbcType=VARCHAR}
        ORDER BY CONVERT(month, SIGNED)
    </select>


    <!--根据公司id获取计薪周期年度-->
    <select id="selectYearPayroll" resultType="java.lang.String">
        SELECT
            year
        FROM
            pay_cycle
        WHERE
            company_id = company_id = #{companyId,jdbcType=BIGINT}
            AND is_generate_payroll = 1
            AND approval_state = 1
        UNION SELECT
            year
        FROM
            rapidly_payroll_excel
        WHERE
            company_id = #{companyId,jdbcType=BIGINT}
            AND is_generate_payroll = 1
        ORDER BY year DESC
    </select>

    <!--根据公司Id，年度查询工资单-->
    <select id="selectPayrollSummary" resultMap="BaseResultDtoMap">
        SELECT
            id,
            CONCAT(month, '月工资单') AS excel_title,
            create_time,
            labor_cost,
            pretax_payroll,
            social_security_fund,
            people_number,
            total_wages,
            is_pay_off,
            0 AS type
        FROM
            pay_cycle
        WHERE
            company_id = company_id = #{companyId,jdbcType=BIGINT}
            AND is_generate_payroll = 1
            AND approval_state = 8
            AND year = #{year,jdbcType=VARCHAR}
        UNION ALL SELECT
            id,
            excel_title,
            create_time,
            0 AS labor_cost,
            0 AS pretax_payroll,
            0 AS social_security_fund,
            payroll_number AS people_number,
            total_wages,
            grant_state as is_pay_off,
            1 AS type
        FROM
            rapidly_payroll_excel
        WHERE
            company_id = #{companyId,jdbcType=BIGINT}
            AND is_generate_payroll = 1
            AND year = #{year,jdbcType=VARCHAR}
        order by create_time desc
    </select>

    <!-- 查询最新的已审批的计薪周期-->
    <select id="selectLastApprovedInfo" resultMap="BaseResultMap" parameterType="java.lang.Long">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        pay_cycle
        WHERE
        company_id=#{companyId} and approval_state=1 order by end_date desc limit 1
    </select>

    <!-- 根据计薪周期主键获取工资发放总额，税前工资，社保公积金-->
    <select id="getSalaryByPayCycleId" resultMap="BaseResultMap" parameterType="java.lang.Long">
        SELECT
            IFNULL(SUM(real_wage), 0) as total_wages,
            IFNULL(SUM(real_wage + personal_tax), 0) as pretax_payroll,
            IFNULL(SUM(social_security_fund_corp), 0) as social_security_fund
        FROM
            customer_payroll
        WHERE
            pay_cycle_id = #{payCycleId,jdbcType=BIGINT}
    </select>
</mapper>