<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xtr.core.persistence.reader.customer.CustomerShebaoOrderDescReaderMapper" >
  <resultMap id="BaseResultMap" type="com.xtr.api.domain.customer.CustomerShebaoOrderDescBean" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="company_shebao_order_id" property="companyShebaoOrderId" jdbcType="BIGINT" />
    <result column="customer_id" property="customerId" jdbcType="BIGINT" />
    <result column="gjj_zy_text" property="gjjZyText" jdbcType="VARCHAR" />
    <result column="gjj_hj_text" property="gjjHjText" jdbcType="VARCHAR" />
    <result column="gjj_bj_text" property="gjjBjText" jdbcType="VARCHAR" />
    <result column="gjj_tj_text" property="gjjTjText" jdbcType="VARCHAR" />
    <result column="gjj_stop_text" property="gjjStopText" jdbcType="VARCHAR" />
    <result column="sb_zy_text" property="sbZyText" jdbcType="VARCHAR" />
    <result column="sb_hj_text" property="sbHjText" jdbcType="VARCHAR" />
    <result column="sb_bj_text" property="sbBjText" jdbcType="VARCHAR" />
    <result column="sb_tj_text" property="sbTjText" jdbcType="VARCHAR" />
    <result column="sb_stop_text" property="sbStopText" jdbcType="VARCHAR" />
    <result column="order_error_text" property="orderErrorText" jdbcType="VARCHAR" />
    <result column="sb_error_text" property="sbErrorText" jdbcType="VARCHAR" />
    <result column="gjj_error_text" property="gjjErrorText" jdbcType="VARCHAR" />
    <result column="sb_error_reason" property="sbErrorReason" jdbcType="VARCHAR" />
    <result column="gjj_error_reason" property="gjjErrorReason" jdbcType="VARCHAR" />
  </resultMap>

  <resultMap id="CustomerShebaoDtoMap" type="com.xtr.api.dto.customer.CustomerShebaoOrderDto" extends="BaseResultMap">
    <result column="dept_id" property="deptId" jdbcType="BIGINT" />
    <result column="dept_name" property="deptName" jdbcType="VARCHAR" />
    <result column="member_name" property="memberName" jdbcType="VARCHAR" />
    <result column="telphone" property="telphone" jdbcType="VARCHAR" />
    <result column="shebao_base" property="shebaoBase" jdbcType="DECIMAL" />
    <result column="gjj_base" property="gjjBase" jdbcType="DECIMAL" />
    <result column="order_type" property="orderType" jdbcType="INTEGER" />
    <result column="overdue_month" property="overdueMonth" jdbcType="TIMESTAMP" />
  </resultMap>

  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    id, company_shebao_order_id, customer_id, gjj_hj_text, gjj_zy_text, gjj_bj_text, gjj_tj_text,
    gjj_stop_text, sb_hj_text, sb_zy_text, sb_bj_text, sb_tj_text, sb_stop_text,sb_error_text,gjj_error_text,order_error_text,sb_error_reason,gjj_error_reason
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select
    <include refid="Base_Column_List" />
    from customer_shebao_order_desc
    where id = #{id,jdbcType=BIGINT}
  </select>

    <select id="selectBjShebaoGjj" resultType="java.lang.Integer">
      select count(id) from customer_shebao_order_desc
      WHERE company_shebao_order_id = #{orderId} and customer_id = #{memerId}
      <if test="requireType == 1">
        and sb_bj_text is not null
      </if>
      <if test="requireType == 2">
       and gjj_bj_text is not null
      </if>
    </select>

  <select id="selectShebaoOrders" resultMap="CustomerShebaoDtoMap" parameterType="com.xtr.api.dto.customer.CustomerShebaoOrderDto">
    select a.*, b.customer_phone as telphone, b.customer_turename as member_name, dep.dep_id as dept_id, dep.dep_name as dept_name,
    c.order_base as shebao_base, d.order_base as gjj_base from customer_shebao_order_desc a
    left join customers b on a.customer_id = b.customer_id
    left join customers_station cs on cs.station_customer_id = a.customer_id
    left join company_deps dep on dep.dep_id = cs.station_dept_id
    left join customer_shebao_order c on a.customer_id = c.customer_id and a.company_shebao_order_id = c.company_shebao_order_id and c.require_type=1 and c.order_type &lt;&gt; 5
    left join customer_shebao_order d on a.customer_id = d.customer_id and a.company_shebao_order_id = d.company_shebao_order_id and d.require_type=2 and d.order_type &lt;&gt; 5
    left join customer_shebao_order e on a.customer_id = e.customer_id and a.company_shebao_order_id = e.company_shebao_order_id and e.sbt_status!=2 and e.sbt_status!=3
    where a.company_shebao_order_id = ${companyShebaoOrderId}
    <if test="isSubmitAccount == 1">
      and ((a.sb_error_reason is null and (a.sb_zy_text is not null or a.sb_hj_text is not null or a.sb_bj_text is not null or a.sb_tj_text is not null or a.sb_stop_text is not null))
      or (a.gjj_error_reason is null and (a.gjj_zy_text is not null or a.gjj_hj_text is not null or a.gjj_bj_text is not null or a.gjj_tj_text is not null or a.gjj_stop_text is not null))
      or (e.id is not null)
      )
    </if>
    <if test="null != deptId and deptId!='' ">
      and cs.station_dept_id = ${deptId}
    </if>
    <if test="null != memberName and memberName != ''">
      and b.customer_turename like concat('%',#{memberName},'%')
    </if>
    group by a.customer_id
  </select>

  <select id="selectByCompanyOrderIdAndCustomerId" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List" />
    from customer_shebao_order_desc
    where company_shebao_order_id = #{companyOrderId}
    and customer_id = #{customerId} limit 1
  </select>
   <!-- 查询当前异常账单的数量-->
    <select id="selectErrorOrderCount" resultType="java.lang.Long" parameterType="java.util.Map">
      SELECT
      count(1)
     FROM
	company_shebao_order a
    LEFT JOIN (
	    SELECT
		count(1) AS number,
		company_shebao_order_id
	   FROM
		customer_shebao_order
	  WHERE
		sbt_status = '2' or sbt_status='3'
	   GROUP BY
		company_shebao_order_id
   ) b ON a.id = b.company_shebao_order_id
   WHERE
	  a.company_id =#{companyId}
	  <if test="isCurrent!=null and isCurrent!=''">
          and a.is_current = #{isCurrent}
      </if>
      and b.number is not null

    </select>

  <select id="selectShebaoErrorOrder" resultMap="CustomerShebaoDtoMap" parameterType="Long">
    select a.*, b.customer_phone as telphone, b.customer_turename as member_name, dep.dep_name as dept_name, b.customer_phone from customer_shebao_order_desc a
    left join customers b on a.`customer_id` = b.customer_id
    left join customers_station cs on cs.station_customer_id = a.customer_id
    left join company_deps dep on dep.dep_id = cs.station_dept_id
    where a.company_shebao_order_id = #{orderId} and (a.sb_error_reason is not null or a.gjj_error_reason is not null)
  </select>

  <!--判断是否有异常-->
  <select id="selectShebaoErrorOrderForNew" resultMap="CustomerShebaoDtoMap" parameterType="Long">
    select a.*,f.overdue_month,f.order_type,b.customer_phone as telphone, b.customer_turename as member_name, dep.dep_name as dept_name, b.customer_phone from customer_shebao_order_desc a
    left join customers b on a.`customer_id` = b.customer_id
    left join customers_station cs on cs.station_customer_id = a.customer_id
    left join company_deps dep on dep.dep_id = cs.station_dept_id
    left join customer_shebao_order f on a.company_shebao_order_id=f.company_shebao_order_id
    where a.company_shebao_order_id = #{orderId} and (a.sb_error_reason is not null or a.gjj_error_reason is not null)
    group by a.company_shebao_order_id
  </select>
</mapper>