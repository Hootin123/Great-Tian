<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xtr.core.persistence.reader.customer.CustomerShebaoOrderReaderMapper" >
  <resultMap id="BaseResultMap" type="com.xtr.api.domain.customer.CustomerShebaoOrderBean" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="customer_id" property="customerId" jdbcType="BIGINT" />
    <result column="company_shebao_order_id" property="companyShebaoOrderId" jdbcType="BIGINT" />
    <result column="shebao_type" property="shebaoType" jdbcType="VARCHAR" />
    <result column="require_type" property="requireType" jdbcType="INTEGER" />
    <result column="order_type" property="orderType" jdbcType="INTEGER" />
    <result column="order_base" property="orderBase" jdbcType="DECIMAL" />
    <result column="overdue_month" property="overdueMonth" jdbcType="DATE" />
    <result column="order_detail" property="orderDetail" jdbcType="VARCHAR" />
    <result column="response_msg" property="responseMsg" jdbcType="VARCHAR" />
    <result column="status" property="status" jdbcType="INTEGER" />
    <result column="payroll_status" property="payrollStatus" jdbcType="INTEGER" />
    <result column="cycle_id" property="cycleId" jdbcType="BIGINT" />
    <result column="org_sum" property="orgSum" jdbcType="DECIMAL" />
    <result column="emp_sum" property="empSum" jdbcType="DECIMAL" />
    <result column="sbt_status" property="sbtStatus" jdbcType="INTEGER" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="shebao_order_overdue" property="shebaoOrderOverdue" jdbcType="DECIMAL" />
    <result column="shebaotong_org_pay" property="shebaotongOrgPay" jdbcType="DECIMAL" />
    <result column="shebaotong_emp_pay" property="shebaotongEmpPay" jdbcType="DECIMAL" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    id, customer_id, company_shebao_order_id, shebao_type, require_type, order_type,
    order_base, overdue_month, order_detail, response_msg, status, payroll_status, cycle_id,
    org_sum, emp_sum, sbt_status, create_time,shebao_order_overdue,shebaotong_org_pay,shebaotong_emp_pay
  </sql>

  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select
    <include refid="Base_Column_List" />
    from customer_shebao_order
    where id = #{id,jdbcType=BIGINT}
  </select>

  <select id="selectShebaoOrder" resultMap="BaseResultMap" parameterType="com.xtr.api.domain.customer.CustomerShebaoOrderBean">
    select
    <include refid="Base_Column_List" />
    from customer_shebao_order where 1=1
    <if test="null != customerId">
      and customer_id = #{customerId}
    </if>
    <if test="null != companyShebaoOrderId">
      and company_shebao_order_id = #{companyShebaoOrderId}
    </if>
    <if test="null != requireType">
      and require_type = #{requireType}
    </if>
    <if test="null != orderType">
      and order_type != #{orderType}
    </if>
    limit 1
  </select>

  <select id="selectShebaoOrderList" resultMap="BaseResultMap" parameterType="com.xtr.api.domain.customer.CustomerShebaoOrderBean">
    select
    <include refid="Base_Column_List" />
    from customer_shebao_order where 1=1
    <if test="null != customerId">
      and customer_id = #{customerId}
    </if>
    <if test="null != companyShebaoOrderId">
      and company_shebao_order_id = #{companyShebaoOrderId}
    </if>
    <if test="null != requireType">
      and require_type = #{requireType}
    </if>
    <if test="null != orderType">
      and order_type = #{orderType}
    </if>
    order by overdue_month
  </select>

  <select id="selectCountByCompanyOrderIdAndOrderType" resultType="java.lang.Integer">
    select
    count(DISTINCT customer_id)
    from customer_shebao_order
    where
    company_shebao_order_id = #{companyOrderId}
    and require_type = #{requireType}
    and order_type = #{orderType}
    and sbt_status &lt;> 2
    and sbt_status &lt;> 3
  </select>

  <select id="selectOrgSum" resultType="java.math.BigDecimal">
    select
    sum(org_sum + emp_sum)
    from customer_shebao_order
    where
    company_shebao_order_id = #{companyOrderId}
    and require_type = #{requireType}
    and sbt_status &lt;> 2
    and sbt_status &lt;> 3
  </select>
  <select id="selectCustomerCount" resultType="java.lang.Integer">
    select
    count(DISTINCT customer_id)
    from customer_shebao_order
    where
    company_shebao_order_id = #{companyOrderId}
    and sbt_status &lt;> 2
    and sbt_status &lt;> 3
    and order_type!=4
  </select>

  <select id="selectEmpSumByCycleId" resultType="java.util.Map">
    SELECT
	t1.customer_id cid,
	sum(t1.emp_sum) empSum,
    sum(t1.shebaotong_emp_pay) sbtEmpSum,
    sum(t1.org_sum) orgSum,
    sum(t1.shebaotong_org_pay) sbtOrgSum,
	t1.require_type requireType
    FROM
        customer_shebao_order t1
        inner join company_shebao_order t2
        on t1.company_shebao_order_id = t2.id
    WHERE
        t1.cycle_id = #{cycleId}
        and order_type in (1,2,3,5)
        and t1.sbt_status &lt;> 2
        and t1.sbt_status &lt;> 3
        <if test="protocolCount > 0">
          and t2.status in (4, 5, 6, 8)
        </if>

        <if test="1 > protocolCount">
          and (
            t2.is_current &lt;> 1
            or
            t2.status in (4, 5, 6, 8)
          )
        </if>
    GROUP BY
        t1.customer_id, t1.require_type
  </select>
  <select id="selectByNotifiy" resultMap="BaseResultMap">

    select
    <include refid="Base_Column_List" />
    from
    customer_shebao_order
    where company_shebao_order_id = #{companyOrderId}
    and customer_id = #{customerId}
    and DATE_FORMAT(overdue_month, '%m-%Y') = DATE_FORMAT(#{orderMonth}, '%m-%Y')
    and require_type = #{requireType}

  </select>

  <select id="selectCustomerLastOrder" resultMap="BaseResultMap">
    SELECT
    t1.*
    FROM
    customer_shebao_order t1
    WHERE
    t1.customer_id = #{customerId}
    AND t1.sbt_status in (2, 3)
    AND t1.company_shebao_order_id = #{currentCompanyOrderId}
  </select>

  <select id="selectOverMonth" resultType="java.lang.Integer">
      select
      count(1)
      from
      customer_shebao_order
      where
      customer_id = #{customerId}
      and
      DATE_FORMAT(overdue_month, '%m-%Y') = DATE_FORMAT(#{overDate}, '%m-%Y')
      and
      require_type = 1
  </select>

  <!--根据条件批量查询员工订单-->
  <!--<select id="selectCustomerShebaoOrderBatch" resultMap="BaseResultMap">-->
    <!--select-->
    <!--<include refid="Base_Column_List" />-->
    <!--from customer_shebao_order-->
    <!--where-->
    <!--<foreach item="item" index="index" collection="list" open="" separator="AND" close="">-->
      <!--company_shebao_order_id=#{item.companyShebaoOrderId}-->
      <!--customer_id=#{item.customerId}-->
      <!--require_type=#{item.requireType}-->
      <!--order_type=#{item.orderType}-->
      <!--<if test="item.overdueMonth != null">-->
        <!--overdue_month=#{item.overdueMonth}-->
      <!--</if>-->
    <!--</foreach>-->
  <!--</select>-->
  <!--查询社保或者公积金 最小的缴纳月 -->
  <select id="selectByCodition" parameterType="com.xtr.api.domain.customer.CustomerShebaoOrderBean" resultMap="BaseResultMap">
    select <include refid="Base_Column_List"/>
    from customer_shebao_order where
    customer_id=#{customerId} AND
    require_type=#{requireType} AND
    order_type=#{orderType}
    order by overdue_month asc limit 1
  </select>

  <select id="selectCustomerLastOrderId" resultType="java.lang.Long">


    SELECT
    t2.company_shebao_order_id
    FROM
    customer_shebao_order t2
    WHERE
    t2.customer_id = #{customerId}
    AND t2.company_shebao_order_id &lt; #{currentCompanyOrderId}
    ORDER BY
    t2.company_shebao_order_id DESC
    LIMIT 1

  </select>
  <select id="selectBjStartEndDate" resultType="java.util.Map">
    select
    min(overdue_month) startMonth,
    max(overdue_month) endMonth
    from customer_shebao_order
    where
    company_shebao_order_id = #{currentCompanyOrderId}
    and customer_id =#{customerId}
    and require_type = #{rtype}
    and order_type = 5
  </select>
  <select id="selectBjBase" resultType="java.math.BigDecimal">
    select
    order_base
    from customer_shebao_order
    where
    company_shebao_order_id = #{currentCompanyOrderId}
    and customer_id =#{customerId}
    and require_type = #{rtype}
    and order_type = 5
    group by order_base
    order by overdue_month
  </select>
  <select id="selectBjDate" resultType="java.util.Date">
    select
    overdue_month
    from customer_shebao_order
    where
    company_shebao_order_id = #{currentCompanyOrderId}
    and customer_id =#{customerId}
    and require_type = #{rtype}
    and order_type = 5
    order by overdue_month
  </select>

  <!-- 查询该公司下所有的异常信息的员工-->
  <select id="selectErrorCustomerIdList" parameterType="java.lang.Long" resultType="java.util.Map">
SELECT
	a.customer_id,
	a.customer_turename,
	c.dep_name,
	a.customer_phone,
    d.company_shebao_order_id,
    f.sb_base,f.gjj_base
FROM
	customers a
LEFT JOIN  customers_station b ON a.customer_id = b.station_customer_id
LEFT JOIN  company_deps c ON c.dep_id = b.station_dept_id
left join  customer_shebao_order_desc d on d.customer_id = a.customer_id
left join  company_shebao_order e on  e.id = d.company_shebao_order_id
left join   customer_shebao f on a.customer_id = f.customer_id
WHERE
 (d.sb_error_reason is not null or d.gjj_error_reason is not null) and
 d.company_shebao_order_id =#{companyShebaoOrderId}
  </select>

  <!--根据企业订单ID获取社保公积金订单-->
  <select id="selectByCompanyOrderId" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List" />
    from
    customer_shebao_order
    where company_shebao_order_id = #{companyShebaoOrderId} and order_type!=5
  </select>

  <select id="selectDismiss" resultType="java.lang.Integer">
    SELECT
        count(1)
    FROM
        customers_record record
    WHERE
        record.record_customer_id = #{customerId}
    AND record.record_operation_type = 3
  </select>

  <!--获取成功的员工订单数据-->
  <select id="selectSuccessShebaoOrderList" resultMap="BaseResultMap" parameterType="com.xtr.api.domain.customer.CustomerShebaoOrderBean">
    select
    <include refid="Base_Column_List" />
    from customer_shebao_order where sbt_status!=2 and sbt_status!=3
    <if test="null != customerId">
      and customer_id = #{customerId}
    </if>
    <if test="null != companyShebaoOrderId">
      and company_shebao_order_id = #{companyShebaoOrderId}
    </if>
    <if test="null != requireType">
      and require_type = #{requireType}
    </if>
  </select>
</mapper>