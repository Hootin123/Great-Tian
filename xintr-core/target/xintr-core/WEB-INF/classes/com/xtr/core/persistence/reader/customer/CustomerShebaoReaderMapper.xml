<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xtr.core.persistence.reader.customer.CustomerShebaoReaderMapper" >
  <resultMap id="BaseResultMap" type="com.xtr.api.domain.customer.CustomerShebaoBean" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="customer_id" property="customerId" jdbcType="BIGINT" />
    <result column="company_id" property="companyId" jdbcType="BIGINT" />
    <result column="current_company_order_id" property="currentCompanyOrderId" jdbcType="BIGINT" />
    <result column="join_city_name" property="joinCityName" jdbcType="VARCHAR" />
    <result column="join_city_code" property="joinCityCode" jdbcType="VARCHAR" />
    <result column="sb_type" property="sbType" jdbcType="VARCHAR" />
    <result column="sb_type_name" property="sbTypeName" jdbcType="VARCHAR" />
    <result column="gjj_type" property="gjjType" jdbcType="VARCHAR" />
    <result column="gjj_type_name" property="gjjTypeName" jdbcType="VARCHAR" />
    <result column="sb_base" property="sbBase" jdbcType="DECIMAL" />
    <result column="gjj_base" property="gjjBase" jdbcType="DECIMAL" />
    <result column="sb_sbt_base" property="sbSbtBase" jdbcType="DECIMAL" />
    <result column="gjj_sbt_base" property="gjjSbtBase" jdbcType="DECIMAL" />
    <result column="sb_shebaotong_status" property="sbShebaotongStatus" jdbcType="INTEGER" />
    <result column="gjj_shebaotong_status" property="gjjShebaotongStatus" jdbcType="INTEGER" />
    <result column="is_sb_keep" property="isSbKeep" jdbcType="INTEGER" />
    <result column="is_gjj_keep" property="isGjjKeep" jdbcType="INTEGER" />
    <result column="sb_join_date" property="sbJoinDate" jdbcType="DATE" />
    <result column="gjj_join_date" property="gjjJoinDate" jdbcType="DATE" />
    <result column="sb_stop_date" property="sbStopDate" jdbcType="DATE" />
    <result column="gjj_stop_date" property="gjjStopDate" jdbcType="DATE" />
    <result column="current_month" property="currentMonth" jdbcType="DATE" />
    <result column="response_msg" property="responseMsg" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
  </resultMap>

  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    id, customer_id, company_id, current_company_order_id, join_city_name, join_city_code, sb_type, sb_type_name, gjj_type, gjj_type_name, sb_base, gjj_base, sb_sbt_base, gjj_sbt_base, sb_shebaotong_status,
    id, customer_id, company_id, current_company_order_id, join_city_name, join_city_code, sb_type, gjj_type, sb_base, gjj_base, sb_shebaotong_status,
    gjj_shebaotong_status, is_sb_keep, is_gjj_keep, sb_join_date, gjj_join_date, sb_stop_date,
    gjj_stop_date, current_month, response_msg, create_time
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from customer_shebao
    where id = #{id,jdbcType=BIGINT}
  </select>


  <select id="selectPage" parameterType="com.xtr.api.domain.customer.CustomerShebaoBean" resultType="java.util.Map">
    SELECT
--     DISTINCT
    cust.customer_id,
    cust.customer_turename,
    cust.customer_phone,
    dep.dep_name,
    cust.customer_social_approve_state approveState,
    cust.customer_social_fail_reason approveReason,
    cs.station_customer_state,
    date_format(cs.station_enter_time, '%Y-%m') = date_format(now(), '%Y-%m') isNew,
    cso.status companyOrderStatus,
--     cr.record_dimissing_time IS NOT NULL isWaitDismissing,
    0 isWaitDismissing,
    date_format(now(), '%Y-%m-%d') >= date_format(cso.last_time, '%Y-%m-%d') isTimeOut,
    date_format(now(), '%Y-%m-%d') >= date_format(cso.order_last_time, '%Y-%m-%d') isOrderTimeOut,
      date_format(cso.last_time, '%m月%d日') as descLastTime,
      date_format(cso.order_last_time, '%m月%d日') as descOrderLastTime,
    sb.*
    FROM
    customers cust
    LEFT JOIN customers_station cs ON cs.station_customer_id = cust.customer_id
    LEFT JOIN company_deps dep ON dep.dep_id = cs.station_dept_id
    LEFT JOIN customer_shebao sb ON sb.customer_id = cust.customer_id
    LEFT JOIN company_shebao_order cso on cso.id = sb.current_company_order_id
--     left join customers_record cr on cr.record_customer_id = cust.customer_id and record_operation_type = 3
    WHERE
    cust.customer_company_id = ${companyId}
    and cs.station_customer_state &lt; 4
    AND (
      (
        cs.station_customer_state = 3
        and(
            date_format(sb.sb_stop_date, '%Y%m') >= date_format(now(), '%Y%m')
            OR
            date_format(sb.gjj_stop_date, '%Y%m') >= date_format(now(), '%Y%m')
        )
      )
      OR(
          cs.station_customer_state = 3
          AND (
              sb.is_gjj_keep = 1
              OR sb.is_sb_keep = 1
          )
      )
      OR (
        cs.station_customer_state &lt; 3
      )
    )
    <if test="joinCityCode != null">
      and sb.join_city_code = #{joinCityCode}
    </if>
    <if test="depId != null">
      and dep.dep_id = #{depId}
    </if>
    <if test="userName != null">
      AND cust.customer_turename LIKE concat('%',#{userName},'%')
    </if>
    <if test="stationEmployMethod != null">
      and cs.station_employ_method = #{stationEmployMethod}
    </if>
    <if test="stationCustomerState != null">
      <if test="stationCustomerState == 2">
        and cs.station_customer_state &lt;= 2
      </if>
      <if test="stationCustomerState != 2">
        and cs.station_customer_state = #{stationCustomerState}
      </if>
    </if>

    <if test="isNew">
        and date_format(cs.station_enter_time, '%Y-%m') = date_format(now(), '%Y-%m')
    </if>

    <if test="isKeepSb">
        and sb.is_sb_keep = 1
    </if>

    <if test="isKeepGjj">
        and sb.is_gjj_keep = 1
    </if>

    <if test="isFailed">
      and cust.customer_social_approve_state = 4
    </if>

    <if test="depName != null">
      and dep.dep_name = #{depName}
    </if>
  </select>

    <select id="selectByCustomerId" resultMap="BaseResultMap">
      select <include refid="Base_Column_List" /> from customer_shebao where customer_id = #{customerId} limit 1
    </select>

  <!--根据员工ID批量查询员工社保公积金信息-->
  <select id="selectBatchForCustomerId" resultMap="BaseResultMap">
    select <include refid="Base_Column_List" /> from customer_shebao
    where customer_id in
    <foreach collection="list" item="item" index="index" open="(" separator="," close=")">
      #{item}
    </foreach>
  </select>
  <select id="selectKeepCustomer" resultMap="BaseResultMap">
    SELECT
    <include refid="Base_Column_List" />
    FROM
        customer_shebao sb
    WHERE
        sb.join_city_code = #{joinCity}
    AND sb.company_id = #{companyId}
    <if test="requireType == 1">
      AND sb.is_sb_keep = 1
      AND (DATE_FORMAT(sb.sb_stop_date, '%m-%Y') &lt;> DATE_FORMAT(#{orderDate}, '%m-%Y') or sb.sb_stop_date is null)
    </if>
    <if test="requireType == 2">
      AND sb.is_gjj_keep = 1
      AND (DATE_FORMAT(sb.gjj_stop_date, '%m-%Y') &lt;> DATE_FORMAT(#{orderDate}, '%m-%Y') or sb.gjj_stop_date is null)
    </if>
  </select>
  <select id="selectStopCustomer" resultMap="BaseResultMap">
    SELECT
    <include refid="Base_Column_List" />
    FROM
    customer_shebao sb
    WHERE
    sb.join_city_code = #{joinCity}
    AND sb.company_id = #{companyId}
    <if test="requireType == 1">
      AND sb.sb_shebaotong_status = 2
      AND (DATE_FORMAT(sb.sb_stop_date, '%m-%Y') = DATE_FORMAT(#{orderDate}, '%m-%Y'))
    </if>
    <if test="requireType == 2">
      AND sb.gjj_shebaotong_status = 2
      AND (DATE_FORMAT(sb.gjj_stop_date, '%m-%Y') = DATE_FORMAT(#{orderDate}, '%m-%Y'))
    </if>
  </select>

  <select id="selectKeepCustomerCount" resultType="java.lang.Integer">
    select count(1) from customer_shebao
    where
    company_id = #{memberCompanyId}
    and
    <if test="stype == 1">
      is_sb_keep = 1
    </if>
    <if test="stype == 2">
      is_gjj_keep = 1
    </if>
  </select>

  <select id="selectJoinCityByCompanyId" resultType="java.util.Map">
    SELECT
	join_city_name,
	join_city_code
    FROM
        customer_shebao
    WHERE
        company_id = #{companyId}
    group by join_city_name, join_city_code
  </select>
  <!-- 查询员工的基本信息-->
  <select id="selectBaseInfo" parameterType="java.lang.Long" resultType="java.util.Map">
       select
         a.customer_turename,
         a.customer_phone,
         a.customer_idcard,
         c.dep_name,
         d.join_city_name,
         d.join_city_code,
         d.sb_base,
         d.gjj_base,
         d.current_month,
         d.sb_base,
         d.gjj_base,
         d.is_sb_keep,
         d.is_gjj_keep,
         d.sb_type,
         d.gjj_type
       from
     customers a
     LEFT JOIN customers_station b ON b.station_customer_id = a.customer_id
     LEFT JOIN company_deps c  ON c.dep_id = b.station_dept_id
     LEFT JOIN customer_shebao d ON d.customer_id = a.customer_id
     where
      a.customer_id=#{customerId}
  </select>
    <select id="selectKeepSbAndGjjType" resultType="java.util.Map">
        (
            SELECT
                join_city_code AS joinCityCode,
                sb_type AS type,
                1 requireType
            FROM
                customer_shebao
            WHERE
                company_id = #{companyId}
            AND is_sb_keep = 1
            GROUP BY
                join_city_code,
                sb_type
        )
        UNION
        (
            SELECT
                join_city_code AS joinCityCode,
                gjj_type AS type,
                2 requireType
            FROM
                customer_shebao
            WHERE
                company_id = #{companyId}
            AND is_gjj_keep = 1
            GROUP BY
                join_city_code,
                gjj_type
        )
    </select>
</mapper>