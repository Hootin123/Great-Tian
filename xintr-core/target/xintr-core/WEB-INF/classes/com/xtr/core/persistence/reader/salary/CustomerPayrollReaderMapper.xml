<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xtr.core.persistence.reader.salary.CustomerPayrollReaderMapper">

    <resultMap id="BaseResultMap" type="com.xtr.api.domain.salary.CustomerPayrollBean">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="customer_id" property="customerId" jdbcType="BIGINT"/>
        <result column="dept_id" property="deptId" jdbcType="BIGINT"/>
        <result column="company_id" property="companyId" jdbcType="BIGINT"/>
        <result column="pay_cycle_id" property="payCycleId" jdbcType="BIGINT"/>
        <result column="base_wages" property="baseWages" jdbcType="DECIMAL"/>
        <result column="add_wages" property="addWages" jdbcType="DECIMAL"/>
        <result column="attendance_deduction" property="attendanceDeduction" jdbcType="DECIMAL"/>
        <result column="absence_day_number" property="absenceDayNumber" jdbcType="DECIMAL"/>
        <result column="total_allowance" property="totalAllowance" jdbcType="DECIMAL"/>
        <result column="total_bonus" property="totalBonus" jdbcType="DECIMAL"/>
        <result column="social_security_fund" property="socialSecurityFund" jdbcType="DECIMAL"/>
        <result column="social_security" property="socialSecurity" jdbcType="DECIMAL"/>
        <result column="fund" property="fund" jdbcType="DECIMAL"/>
        <result column="pretax" property="pretax" jdbcType="DECIMAL"/>
        <result column="should_amount" property="shouldAmount" jdbcType="DECIMAL"/>
        <result column="personal_tax" property="personalTax" jdbcType="DECIMAL"/>
        <result column="after_tax" property="afterTax" jdbcType="DECIMAL"/>
        <result column="real_wage" property="realWage" jdbcType="DECIMAL"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="is_allowance_update" property="isAllowanceUpdate" jdbcType="INTEGER"/>
        <result column="is_bonus_update" property="isBonusUpdate" jdbcType="INTEGER"/>
        <result column="is_payrule_update" property="isPayruleUpdate" jdbcType="INTEGER"/>
        <result column="is_pay_off" property="isPayOff" jdbcType="INTEGER"/>
        <result column="pay_status" property="payStatus" jdbcType="INTEGER"/>
        <result column="wiped_amount" property="wipedAmount" jdbcType="DECIMAL"/>
        <result column="appraisals_supplement" property="appraisalsSupplement" jdbcType="DECIMAL"/>
        <result column="bonus_json_str" property="bonusJsonStr" jdbcType="VARCHAR"/>
        <result column="allowance_json_str" property="allowanceJsonStr" jdbcType="VARCHAR"/>
        <result column="social_security_fund_corp" property="socialSecurityFundCorp" jdbcType="DECIMAL"/>
    </resultMap>
    <resultMap id="BaseDtoMap" type="com.xtr.api.dto.salary.CustomerPayrollDto" extends="BaseResultMap">
        <result column="userName" property="userName" jdbcType="VARCHAR"/>
        <result column="deptName" property="deptName" jdbcType="VARCHAR"/>
        <result column="mobilePhone" property="mobilePhone" jdbcType="VARCHAR"/>
        <result column="jobNumber" property="jobNumber" jdbcType="VARCHAR"/>
        <result column="stationName" property="stationName" jdbcType="VARCHAR"/>
        <result column="entryDate" property="entryDate" jdbcType="TIMESTAMP"/>
        <result column="employMethod" property="employMethod" jdbcType="INTEGER"/>
        <result column="idCard" property="idCard" jdbcType="VARCHAR"/>
        <result column="bankNumber" property="bankNumber" jdbcType="VARCHAR"/>
        <result column="bankAccount" property="bankAccount" jdbcType="VARCHAR"/>
        <result column="isSalary" property="isSalary" jdbcType="VARCHAR"/>
        <result column="stationCustomerState" property="stationCustomerState" jdbcType="INTEGER"/>
        <result column="customerCurrentExpense" property="customerCurrentExpense" jdbcType="DECIMAL"/>

        <!--* 津贴列表项-->
        <!--<association column="id" property="allowanceList"-->
                     <!--select="com.xtr.core.persistence.reader.salary.CustomerPayrollDetailReaderMapper.selectAllowanceByPayrollId"/>-->

        <!--&lt;!&ndash;* 奖金列表项&ndash;&gt;-->
        <!--<association column="id" property="bonusList"-->
                     <!--select="com.xtr.core.persistence.reader.salary.CustomerPayrollDetailReaderMapper.selectBonusByPayrollId"/>-->
    </resultMap>

    <sql id="Base_Column_List">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        a.id, a.customer_id, a.dept_id, a.company_id,a.pay_cycle_id, a.base_wages, a.add_wages, a.attendance_deduction,
        a.absence_day_number, a.total_allowance,a.total_bonus, a.social_security_fund, a.social_security, a.fund,
        a.pretax, a.should_amount, a.personal_tax, a.after_tax, a.real_wage, a.create_time, a.is_allowance_update,
        a.is_bonus_update, a.is_payrule_update,a.is_pay_off, a.pay_status, a.wiped_amount, a.appraisals_supplement,
        a.bonus_json_str,a.allowance_json_str,a.social_security_fund_corp
    </sql>
    <!-- 查询条件 -->
    <sql id="Example_Where_Clause">
        <if test="id!=null and id!=''">
            AND a.id = #{id}
        </if>
        <if test="payCycleId != null">
            AND a.pay_cycle_id = #{payCycleId,jdbcType=BIGINT}
        </if>
        <if test="customerId != null">
            AND a.customer_id = #{customerId,jdbcType=BIGINT}
        </if>
        <if test="deptId != null">
            AND a.dept_id = #{deptId,jdbcType=BIGINT}
        </if>
        <if test="companyId != null">
            AND a.company_id = #{companyId,jdbcType=BIGINT}
        </if>
        <if test="baseWages != null">
            AND a.base_wages = #{baseWages,jdbcType=DECIMAL}
        </if>
        <if test="addWages != null">
            AND a.add_wages = #{addWages,jdbcType=DECIMAL}
        </if>
        <if test="attendanceDeduction != null">
            AND a.attendance_deduction = #{attendanceDeduction,jdbcType=DECIMAL}
        </if>
        <if test="absenceDayNumber != null">
            AND a.absence_day_number = #{absenceDayNumber,jdbcType=DECIMAL}
        </if>
        <if test="totalAllowance != null">
            AND a.total_allowance = #{totalAllowance,jdbcType=DECIMAL}
        </if>
        <if test="socialSecurityFund != null">
            AND a.social_security_fund = #{socialSecurityFund,jdbcType=DECIMAL}
        </if>
        <if test="socialSecurity != null">
            AND a.social_security = #{socialSecurity,jdbcType=DECIMAL}
        </if>
        <if test="fund != null">
            AND a.fund = #{fund,jdbcType=DECIMAL}
        </if>
        <if test="pretax != null">
            AND a.pretax = #{pretax,jdbcType=DECIMAL}
        </if>
        <if test="shouldAmount != null">
            AND a.should_amount = #{shouldAmount,jdbcType=DECIMAL}
        </if>
        <if test="personalTax != null">
            AND a.personal_tax = #{personalTax,jdbcType=DECIMAL}
        </if>
        <if test="afterTax != null">
            AND a.after_tax = #{afterTax,jdbcType=DECIMAL}
        </if>
        <if test="realWage != null">
            AND a.real_wage = #{realWage,jdbcType=DECIMAL}
        </if>
        <if test="createTime != null">
            AND a.create_time = #{createTime,jdbcType=TIMESTAMP}
        </if>
        <if test="isAllowanceUpdate != null">
            AND a.is_allowance_update = #{isAllowanceUpdate,jdbcType=INTEGER}
        </if>
        <if test="isBonusUpdate != null">
            AND a.is_bonus_update = #{isBonusUpdate,jdbcType=INTEGER}
        </if>
        <if test="isPayruleUpdate != null">
            AND a.is_payrule_update = #{isPayruleUpdate,jdbcType=INTEGER}
        </if>
        <if test="isPayOff != null">
            AND a.is_pay_off = #{isPayOff,jdbcType=INTEGER}
        </if>
        <if test="socialSecurityFundCorp != null">
            AND a.social_security_fund_corp = #{socialSecurityFundCorp,jdbcType=DECIMAL}
        </if>
    </sql>
    <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select
        <include refid="Base_Column_List"/>
        from customer_payroll a
        where a.id = #{id,jdbcType=BIGINT}
    </select>

    <!-- 分页查询工资单-->
    <select id="selectPageList" resultMap="BaseDtoMap" parameterType="com.xtr.api.dto.salary.CustomerPayrollDto" >
        select
        <include refid="Base_Column_List"/>,b.customer_turename as userName,c.dep_name as deptName,
        b.customer_phone as mobilePhone,d.station_customer_number as jobNumber,d.station_station_name as stationName,
        d.station_enter_time as entryDate,d.station_employ_method as employMethod,b.customer_idcard as idCard,
        b.customer_banknumber as bankNumber,b.customer_bank as bankAccount,d.station_customer_state as
        stationCustomerState,if(b.customer_regular_time,1,0) as isSalary,ifnull(b.customer_current_expense,0) as customerCurrentExpense
        from customer_payroll a
        left join customers b
        on b.customer_id = a.customer_id
        left JOIN company_deps c
        on a.dept_id = c.dep_id
        left join customers_station d
        on d.station_customer_id = a.customer_id
        WHERE 1= 1
        <include refid="Example_Where_Clause"/>
        <if test="customerList!=null">
            AND a.customer_id in
            <foreach collection="customerList" item="dto"
                     index="index" open="(" close=")" separator=",">
                #{dto.customerId}
            </foreach>
        </if>
        order by b.customer_turename asc
    </select>

    <!-- 根据Id查询工资单详情-->
    <select id="selectById" resultMap="BaseDtoMap" parameterType="java.lang.Long">
        select
        <include refid="Base_Column_List"/>,b.customer_turename as userName,c.dep_name as deptName,
        b.customer_phone as mobilePhone,d.station_customer_number as jobNumber,d.station_station_name as stationName,
        d.station_enter_time as entryDate,d.station_employ_method as employMethod,b.customer_idcard as idCard,
        b.customer_banknumber as bankNumber,b.customer_bank as bankAccount,d.station_customer_state as
        stationCustomerState,if(b.customer_regular_time,1,0) as isSalary,ifnull(b.customer_current_expense,0) as customerCurrentExpense
        from customer_payroll a
        left join customers b
        on b.customer_id = a.customer_id
        left JOIN company_deps c
        on a.dept_id = c.dep_id
        left join customers_station d
        on d.station_customer_id = a.customer_id
        where a.id = #{id,jdbcType=BIGINT}
    </select>

    <!-- 根据Id查询工资单详情-->
    <select id="selectCustomerPayroll" resultMap="BaseDtoMap"
            parameterType="com.xtr.api.dto.salary.CustomerPayrollQueryDto">
        select
        <include refid="Base_Column_List"/>,b.customer_turename as userName,c.dep_name as deptName,
        b.customer_phone as mobilePhone,d.station_customer_number as jobNumber,d.station_station_name as stationName,
        d.station_enter_time as entryDate,d.station_employ_method as employMethod,b.customer_idcard as idCard,
        b.customer_banknumber as bankNumber,b.customer_bank as bankAccount,d.station_customer_state as
        stationCustomerState,if(b.customer_regular_time,1,0) as isSalary,ifnull(b.customer_current_expense,0) as customerCurrentExpense
        from customer_payroll a
        left join customers b
        on b.customer_id = a.customer_id
        left JOIN company_deps c
        on a.dept_id = c.dep_id
        left join customers_station d
        on d.station_customer_id = a.customer_id
        where a.company_id = ${companyId}
        and a.pay_cycle_id = ${payCycleId}
        <if test="stationEmployMethod!=null">
            and d.station_employ_method = ${stationEmployMethod}
        </if>
        <if test="stationCustomerState!=null">
            and d.station_customer_state = ${stationCustomerState}
        </if>
        <if test="deptId!=null">
            and d.station_dept_id = #{deptId,jdbcType=BIGINT}
        </if>
        <if test="userName!=null">
            and b.customer_turename = #{userName,jdbcType=VARCHAR}
        </if>
        <if test="allowanceId!=null">
            <![CDATA[and allowance_json_str not like '%detailValue":0,"resourceId":${allowanceId}%' and allowance_json_str like '%"resourceId":${allowanceId}%']]>
        </if>
        order by b.customer_turename
    </select>

    <!-- 根据公司id、计薪id、员工id获取工资单-->
    <select id="selectByCompanyIdAndPayCycleId" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from customer_payroll a
        where a.company_id = #{companyId,jdbcType=BIGINT}
        and a.pay_cycle_id = #{payCycleId,jdbcType=BIGINT}
        and a.customer_id = #{customerId,jdbcType=BIGINT}
    </select>

    <!-- 根据计薪id获取所有工资单-->
    <select id="selectByPayCycleId" resultMap="BaseResultMap" parameterType="java.lang.Long">
        select
        <include refid="Base_Column_List"/>
        from customer_payroll a
        where a.pay_cycle_id = #{payCycleId,jdbcType=BIGINT}
    </select>

    <!-- 根据计薪id获取工资未发放的工资单-->
    <select id="selectPayrollByPayCycleId" resultMap="BaseResultMap" parameterType="java.lang.Long">
        select
        <include refid="Base_Column_List"/>
        from customer_payroll a
        where a.pay_cycle_id = #{payCycleId,jdbcType=BIGINT}
        and a.is_pay_off = 0
    </select>

    <!--根据员工ID查询最新工资单-->
    <select id="selectByCustomerId" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from customer_payroll a
        where pay_cycle_id = #{payCycleId}
        AND
        a.customer_id = #{customerId}
    </select>

    <!-- 获取工资发放总金额-->
    <select id="getTotalWages" resultType="decimal" parameterType="java.lang.Long">
        SELECT ifnull(sum(real_wage),0) from customer_payroll where pay_cycle_id = #{payCycleId,jdbcType=BIGINT}
    </select>

    <!-- 获取发薪总人数-->
    <select id="getTotalPeopleNumber" resultType="integer" parameterType="java.lang.Long">
        SELECT count(1) from customer_payroll where pay_cycle_id = #{payCycleId,jdbcType=BIGINT}
    </select>

    <!-- 查询未支付订单-->
    <select id="selectPayFailedOrder" resultType="java.util.Map"
            parameterType="com.xtr.api.dto.customer.CustomerUnPayOrderDto">
        SELECT
        cr.recharge_id,
        c.company_id,
        c.company_name,
        cr.recharge_number,
        pcycle.pay_day,
        cust.customer_turename,
        cust.customer_phone,
        cust.customer_idcard,
        cust.customer_bank,
        cust.customer_banknumber,
        cr.recharge_money real_wage,
        cp.remark,
        cr.recharge_state,
        cr.recharge_recall_result,
        cp.finance_user,
        cp.fail_msg
        FROM
        customer_recharges cr
        INNER JOIN customer_payroll cp ON cp.id = cr.resource_id
        INNER JOIN companys c ON c.company_id = cp.company_id
        INNER JOIN customers cust ON cp.customer_id = cust.customer_id
        INNER JOIN pay_cycle pcycle ON pcycle.id = cp.pay_cycle_id
        WHERE
        cr.recharge_type = 2

        <if test="payStatus != null">
            <if test="payStatus == 1">
                AND cp.pay_status = 1
            </if>
            <if test="payStatus == 2">
                AND (cp.pay_status is null or cp.pay_status = 1)
            </if>
        </if>

        <if test="payStatus == null">
            AND cp.pay_status is null
        </if>

        <!--<option value="">全部</option>-->
        <!--<option value="1">发薪异常</option>-->
        <!--<option value="0">等待回调</option>-->
        <!--<option value="3">系统处理中</option>-->
        <!--<option value="2">处理成功</option>-->

        <if test="rechargeState != null">
            <if test="rechargeState == 0">
                AND
                (cr.recharge_state = 0 or (cr.recharge_state = 2 and cr.recharge_recall_result = 0))
            </if>
            <if test="rechargeState == 1">
                AND cr.recharge_state = 1
                and cr.recharge_recall_result = 2
            </if>
            <if test="rechargeState == 2">
                AND cr.recharge_state = 2
                AND cr.recharge_recall_result = 1
            </if>
            <if test="rechargeState == 3">
                AND cr.recharge_state = 0
                AND cr.recharge_recall_result = 0
            </if>

        </if>
        <if test="rechargeBumber != null">
            AND cr.recharge_number = #{rechargeBumber}
        </if>
        <if test="financeUser != null">
            AND cp.finance_user like CONCAT('%',#{financeUser},'%')
        </if>
        <if test="companyName != null">
            AND c.company_name like CONCAT('%',#{companyName},'%')
        </if>
    </select>

    <select id="selectChangeCustomerPayroll" resultMap="BaseResultMap" parameterType="java.lang.Long">
        SELECT
        <include refid="Base_Column_List"/>
        from customer_payroll a
        where pay_cycle_id = #{payCycleId}
        AND a.company_id = #{companyId,jdbcType=BIGINT}
        and (a.is_allowance_update = 1 or a.is_bonus_update = 1 or a.is_payrule_update = 1)
    </select>

    <!--根据过滤条件查询列表-->
    <select id="selectPayFailedOrderList" resultType="java.util.Map"
            parameterType="com.xtr.api.dto.customer.CustomerUnPayOrderDto">
        select
        opeationType,
        recharge_id,
        company_id,
        company_name,
        recharge_number,
        pay_day,
        customer_turename,
        customer_phone,
        customer_idcard,
        customer_bank,
        customer_banknumber,
         real_wage,
        remark,
        recharge_state,
        recharge_recall_result,
        finance_user,
        fail_msg,
        recharge_addtime
        from (
        <if test="opeationType != null">
            <if test="opeationType == 1">
                SELECT
                1 as opeationType,
                cr.recharge_id,
                c.company_id,
                c.company_name,
                cr.recharge_number,
                pcycle.pay_day,
                cust.customer_turename,
                cust.customer_phone,
                cust.customer_idcard,
                cust.customer_bank,
                cust.customer_banknumber,
                cr.recharge_money real_wage,
                cp.remark,
                cr.recharge_state,
                cr.recharge_recall_result,
                cp.finance_user,
                cp.fail_msg,
                cr.recharge_addtime
                FROM
                customer_recharges cr
                INNER JOIN customer_payroll cp ON cp.id = cr.resource_id
                INNER JOIN companys c ON c.company_id = cp.company_id
                INNER JOIN customers cust ON cp.customer_id = cust.customer_id
                INNER JOIN pay_cycle pcycle ON pcycle.id = cp.pay_cycle_id
                WHERE
                cr.recharge_type = 2

                <if test="payStatus != null">
                    <if test="payStatus == 1">
                        AND cp.pay_status = 1
                    </if>
                    <if test="payStatus == 2">
                        AND (cp.pay_status is null or cp.pay_status = 1)
                    </if>
                </if>

                <if test="payStatus == null">
                    AND cp.pay_status is null
                </if>

                <!--<option value="">全部</option>-->
                <!--<option value="1">发薪异常</option>-->
                <!--<option value="0">等待回调</option>-->
                <!--<option value="3">系统处理中</option>-->
                <!--<option value="2">处理成功</option>-->

                <if test="rechargeState != null">
                    <if test="rechargeState == 0">
                        AND
                        (cr.recharge_state = 0 or (cr.recharge_state = 2 and cr.recharge_recall_result = 0))
                    </if>
                    <if test="rechargeState == 1">
                        AND cr.recharge_state = 1
                        and cr.recharge_recall_result = 2
                    </if>
                    <if test="rechargeState == 2">
                        AND cr.recharge_state = 2
                        AND cr.recharge_recall_result = 1
                    </if>
                    <if test="rechargeState == 3">
                        AND cr.recharge_state = 0
                        AND cr.recharge_recall_result = 0
                    </if>
                    <if test="rechargeState == 4">
                        AND cr.recharge_state != 2
                    </if>

                </if>
                <if test="rechargeBumber != null">
                    AND cr.recharge_number = #{rechargeBumber}
                </if>
                <if test="financeUser != null">
                    AND cp.finance_user like CONCAT('%',#{financeUser},'%')
                </if>
                <if test="companyName != null">
                    AND c.company_name like CONCAT('%',#{companyName},'%')
                </if>

            </if>
            <if test="opeationType == 2">
                SELECT
                2 as opeationType,
                rp.id recharge_id,
                com.company_id,
                com.company_name,
                rp.order_no recharge_number,
                rpe.pay_day,
                rp.customer_name customer_turename,
                NULL as customer_phone,
                rp.id_card customer_idcard,
                rp.bank_account customer_bank,
                rp.bank_number customer_banknumber,
                rp.real_wage real_wage,
                rp.remark remark,
                rp.is_pay_off as recharge_state,
                rp.callback_state recharge_recall_result,
                rp.finance_user finance_user,
                rp.fail_msg fail_msg,
                rp.create_time recharge_addtime
                FROM
                rapidly_payroll rp
                INNER JOIN companys com ON com.company_id = rp.company_id
                INNER JOIN rapidly_payroll_excel rpe on rp.rapidly_payroll_excel_id=rpe.id
                WHERE 1=1
                <if test="payStatus != null">
                    <if test="payStatus == 1">
                        AND rp.pay_status = 1
                    </if>
                    <if test="payStatus == 2">
                        AND (rp.pay_status is null or rp.pay_status = 1)
                    </if>
                </if>

                <if test="payStatus == null">
                    AND rp.pay_status is null
                </if>

                <!--<option value="">全部</option>-->
                <!--<option value="1">发薪异常</option>-->
                <!--<option value="0">等待回调</option>-->
                <!--<option value="3">系统处理中</option>-->
                <!--<option value="2">处理成功</option>-->

                <if test="rechargeState != null">
                    <if test="rechargeState == 0">
                        and rp.callback_state = 0
                    </if>
                    <if test="rechargeState == 1">
                        and rp.callback_state = 2
                    </if>
                    <if test="rechargeState == 2">
                        AND rp.callback_state = 1
                    </if>
                    <if test="rechargeState == 3">
                        AND (rp.callback_state is null or rp.callback_state=-1) and is_pay_off=0
                    </if>
                    <if test="rechargeState == 4">
                        AND rp.callback_state !=1
                    </if>
                </if>
                <if test="rechargeBumber != null">
                    AND rp.order_no = #{rechargeBumber}
                </if>
                <if test="financeUser != null">
                    AND cp.finance_user like CONCAT('%',#{financeUser},'%')
                </if>
                <if test="companyName != null">
                    AND com.company_name like CONCAT('%',#{companyName},'%')
                </if>
            </if>
            <if test="opeationType == 3">
                SELECT
                3 as opeationType,
                cr.recharge_id,
                c.company_id,
                c.company_name,
                cr.recharge_number,
                NULL as pay_day,
                cust.customer_turename,
                cust.customer_phone,
                cust.customer_idcard,
                cust.customer_bank,
                cust.customer_banknumber,
                cr.recharge_money real_wage,
                cs.supplement_remark  remark,
                cr.recharge_state,
                cr.recharge_recall_result,
                cs.supplement_finance_user finance_user,
                cs.supplement_fail_msg fail_msg,
                cr.recharge_addtime
                FROM
                customer_recharges cr
                INNER JOIN customers_supplement cs ON cs.supplement_id=cr.resource_id
                INNER JOIN company_shebao_order cso ON cso.id = cs.supplement_company_order_id
                INNER JOIN companys c ON c.company_id = cso.company_id
                INNER JOIN customers cust ON cr.recharge_customer_id = cust.customer_id
                WHERE
                cr.recharge_type = 8

                <if test="payStatus != null">
                    <if test="payStatus == 1">
                        AND cs.supplement_pay_status = 1
                    </if>
                    <if test="payStatus == 2">
                        AND (cs.supplement_pay_status is null or cs.supplement_pay_status = 1)
                    </if>
                </if>

                <if test="payStatus == null">
                    AND cs.supplement_pay_status is null
                </if>

                <!--<option value="">全部</option>-->
                <!--<option value="1">发薪异常</option>-->
                <!--<option value="0">等待回调</option>-->
                <!--<option value="3">系统处理中</option>-->
                <!--<option value="2">处理成功</option>-->

                <if test="rechargeState != null">
                    <if test="rechargeState == 0">
                        AND
                        (cr.recharge_state = 0 or (cr.recharge_state = 2 and cr.recharge_recall_result = 0))
                    </if>
                    <if test="rechargeState == 1">
                        AND cr.recharge_state = 1
                        and cr.recharge_recall_result = 2
                    </if>
                    <if test="rechargeState == 2">
                        AND cr.recharge_state = 2
                        AND cr.recharge_recall_result = 1
                    </if>
                    <if test="rechargeState == 3">
                        AND cr.recharge_state = 0
                        AND cr.recharge_recall_result = 0
                    </if>
                    <if test="rechargeState == 4">
                        AND cr.recharge_state != 2
                    </if>

                </if>
                <if test="rechargeBumber != null">
                    AND cr.recharge_number = #{rechargeBumber}
                </if>
                <if test="financeUser != null">
                    AND cs.supplement_finance_user like CONCAT('%',#{financeUser},'%')
                </if>
                <if test="companyName != null">
                    AND c.company_name like CONCAT('%',#{companyName},'%')
                </if>
            </if>
        </if>
        <if test="opeationType == null">
            SELECT
            1 as opeationType,
            cr.recharge_id,
            c.company_id,
            c.company_name,
            cr.recharge_number,
            pcycle.pay_day,
            cust.customer_turename,
            cust.customer_phone,
            cust.customer_idcard,
            cust.customer_bank,
            cust.customer_banknumber,
            cr.recharge_money real_wage,
            cp.remark,
            cr.recharge_state,
            cr.recharge_recall_result,
            cp.finance_user,
            cp.fail_msg,
            cr.recharge_addtime
            FROM
            customer_recharges cr
            INNER JOIN customer_payroll cp ON cp.id = cr.resource_id
            INNER JOIN companys c ON c.company_id = cp.company_id
            INNER JOIN customers cust ON cp.customer_id = cust.customer_id
            INNER JOIN pay_cycle pcycle ON pcycle.id = cp.pay_cycle_id
            WHERE
            cr.recharge_type = 2

            <if test="payStatus != null">
                <if test="payStatus == 1">
                    AND cp.pay_status = 1
                </if>
                <if test="payStatus == 2">
                    AND (cp.pay_status is null or cp.pay_status = 1)
                </if>
            </if>

            <if test="payStatus == null">
                AND cp.pay_status is null
            </if>

            <!--<option value="">全部</option>-->
            <!--<option value="1">发薪异常</option>-->
            <!--<option value="0">等待回调</option>-->
            <!--<option value="3">系统处理中</option>-->
            <!--<option value="2">处理成功</option>-->

            <if test="rechargeState != null">
                <if test="rechargeState == 0">
                    AND
                    (cr.recharge_state = 0 or (cr.recharge_state = 2 and cr.recharge_recall_result = 0))
                </if>
                <if test="rechargeState == 1">
                    AND cr.recharge_state = 1
                    and cr.recharge_recall_result = 2
                </if>
                <if test="rechargeState == 2">
                    AND cr.recharge_state = 2
                    AND cr.recharge_recall_result = 1
                </if>
                <if test="rechargeState == 3">
                    AND cr.recharge_state = 0
                    AND cr.recharge_recall_result = 0
                </if>
                <if test="rechargeState == 4">
                    AND cr.recharge_state != 2
                </if>

            </if>
            <if test="rechargeBumber != null">
                AND cr.recharge_number = #{rechargeBumber}
            </if>
            <if test="financeUser != null">
                AND cp.finance_user like CONCAT('%',#{financeUser},'%')
            </if>
            <if test="companyName != null">
                AND c.company_name like CONCAT('%',#{companyName},'%')
            </if>
            union all
            SELECT
            2 as opeationType,
            rp.id recharge_id,
            com.company_id,
            com.company_name,
            rp.order_no recharge_number,
            rpe.pay_day,
            rp.customer_name customer_turename,
            NULL as customer_phone,
            rp.id_card customer_idcard,
            rp.bank_account customer_bank,
            rp.bank_number customer_banknumber,
            rp.real_wage real_wage,
            rp.remark remark,
            rp.is_pay_off as recharge_state,
            rp.callback_state recharge_recall_result,
            rp.finance_user finance_user,
            rp.fail_msg fail_msg,
            rp.create_time recharge_addtime
            FROM
            rapidly_payroll rp
            INNER JOIN companys com ON com.company_id = rp.company_id
            INNER JOIN rapidly_payroll_excel rpe on rp.rapidly_payroll_excel_id=rpe.id
            WHERE 1=1
            <if test="payStatus != null">
                <if test="payStatus == 1">
                    AND rp.pay_status = 1
                </if>
                <if test="payStatus == 2">
                    AND (rp.pay_status is null or rp.pay_status = 1)
                </if>
            </if>

            <if test="payStatus == null">
                AND rp.pay_status is null
            </if>

            <!--<option value="">全部</option>-->
            <!--<option value="1">发薪异常</option>-->
            <!--<option value="0">等待回调</option>-->
            <!--<option value="3">系统处理中</option>-->
            <!--<option value="2">处理成功</option>-->

            <if test="rechargeState != null">
                <if test="rechargeState == 0">
                    and rp.callback_state = 0
                </if>
                <if test="rechargeState == 1">
                    and rp.callback_state = 2
                </if>
                <if test="rechargeState == 2">
                    AND rp.callback_state = 1
                </if>
                <if test="rechargeState == 3">
                    AND (rp.callback_state is null or rp.callback_state=-1) and is_pay_off=0
                </if>
                <if test="rechargeState == 4">
                    AND rp.callback_state !=1
                </if>
            </if>
            <if test="rechargeBumber != null">
                AND rp.order_no = #{rechargeBumber}
            </if>
            <if test="financeUser != null">
                AND cp.finance_user like CONCAT('%',#{financeUser},'%')
            </if>
            <if test="companyName != null">
                AND com.company_name like CONCAT('%',#{companyName},'%')
            </if>

            union all
            SELECT
            3 as opeationType,
            cr.recharge_id,
            c.company_id,
            c.company_name,
            cr.recharge_number,
            NULL as pay_day,
            cust.customer_turename,
            cust.customer_phone,
            cust.customer_idcard,
            cust.customer_bank,
            cust.customer_banknumber,
            cr.recharge_money real_wage,
            cs.supplement_remark  remark,
            cr.recharge_state,
            cr.recharge_recall_result,
            cs.supplement_finance_user finance_user,
            cs.supplement_fail_msg fail_msg,
            cr.recharge_addtime
            FROM
            customer_recharges cr
            INNER JOIN customers_supplement cs ON cs.supplement_id=cr.resource_id
            INNER JOIN company_shebao_order cso ON cso.id = cs.supplement_company_order_id
            INNER JOIN companys c ON c.company_id = cso.company_id
            INNER JOIN customers cust ON cr.recharge_customer_id = cust.customer_id
            WHERE
            cr.recharge_type = 8

            <if test="payStatus != null">
                <if test="payStatus == 1">
                    AND cs.supplement_pay_status = 1
                </if>
                <if test="payStatus == 2">
                    AND (cs.supplement_pay_status is null or cs.supplement_pay_status = 1)
                </if>
            </if>

            <if test="payStatus == null">
                AND cs.supplement_pay_status is null
            </if>

            <!--<option value="">全部</option>-->
            <!--<option value="1">发薪异常</option>-->
            <!--<option value="0">等待回调</option>-->
            <!--<option value="3">系统处理中</option>-->
            <!--<option value="2">处理成功</option>-->

            <if test="rechargeState != null">
                <if test="rechargeState == 0">
                    AND
                    (cr.recharge_state = 0 or (cr.recharge_state = 2 and cr.recharge_recall_result = 0))
                </if>
                <if test="rechargeState == 1">
                    AND cr.recharge_state = 1
                    and cr.recharge_recall_result = 2
                </if>
                <if test="rechargeState == 2">
                    AND cr.recharge_state = 2
                    AND cr.recharge_recall_result = 1
                </if>
                <if test="rechargeState == 3">
                    AND cr.recharge_state = 0
                    AND cr.recharge_recall_result = 0
                </if>
                <if test="rechargeState == 4">
                    AND cr.recharge_state != 2
                </if>

            </if>
            <if test="rechargeBumber != null">
                AND cr.recharge_number = #{rechargeBumber}
            </if>
            <if test="financeUser != null">
                AND cs.supplement_finance_user like CONCAT('%',#{financeUser},'%')
            </if>
            <if test="companyName != null">
                AND c.company_name like CONCAT('%',#{companyName},'%')
            </if>
        </if>
        )A order by A.recharge_addtime desc
    </select>
</mapper>