<!DOCTYPE html>
<html lang="en" id='html'>
<head>
	#parse("comm/head.vm")
	<meta charset="UTF-8">
	<title>绑定</title>
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,minimum-scale=1,maximum-scale=1">
    <link rel="stylesheet" type="text/css" href="#springUrl('/resource/css/wechatCustomerNew/bind.css')">
</head>
<body>
	<div class="logo">
		<img  src="#springUrl('/resource/img/wechatCustomerNew/logo.png')"  />
	</div>
	<form id="bindForm">
		<!-- 绑定来源-->
		<input type="hidden" name="from" value="$!{from}"/>
		<ul>
			<li class='phone'>
				<input type="text" name="phoneNumber" placeholder="输入您的手机号"/>
				<em></em>
				<b></b>
				<i></i>
			</li>
			<li class='phoneCode'>
				<input type="text" name="phoneCode" placeholder="输入您收到的验证码"/>
				<span>获取验证码</span>
				<em></em>
			</li>
		</ul>
	</form>
	<div class="hint" style="display: none">验证码获取错误</div>
	<footer>
		<div class="bindPhone">绑定手机</div>
	</footer>
</body>
<script type="text/javascript">
	$(function(){

    var fphone = false, fphoneCode=false;
	//验证手机号
	$('.phone input').blur(function(){
		testPhone()
	});

	function testPhone(){
		var  reg=/^1[3|5|7|8]\d{9}$/;
		if($(".phone input").val()=='' || $(".phone input").val()==undefined ){
			$('.phone b').html('请输入手机号码');
			$('.phone i').removeClass('show');
			fphone = false;	
		}
	 	else if(reg.test($(".phone input").val())){
	 		$('.phone b').html('');
			$('.phone i').addClass('show')
			fphone = true;
		}
		else{
			$('.phone b').html('请输入正确的手机号');
			$('.phone i').removeClass('show');
			fphone = false;	
		}
	};

//手机验证码
    function testPhoneCode(){
        var code = $("input[name='phoneCode']").val();
        if(code==""||code==null||code==undefined){
            //请输入验证码
//            animateHint($('.hint'),'请输入验证码')
            $(".hint").show().html("请输入验证码");
            fphoneCode=false;
        }else{
            fphoneCode=true;
        }
    }
	
	//..........发送手机验证码
	var timer;
	var getCode=true;
		$('.phoneCode span').on('click',function(){
            var path =  BASE_PATH+'/wechatCustomer/sendPhoneMsg.htm';

            if(path.indexOf(";jsessionid")>0 || path.indexOf(";xintr-customer")>0){
                path =path.substr(0,path.indexOf(";"))+'/wechatCustomer/sendPhoneMsg.htm';
            }
            testPhone();
			if(getCode&&fphone){
                $.ajax({
                    type: 'post',
                    url: path,
                    data: {'memberPhone':$("input[name='phoneNumber']").val()},
                    dataType:'json',
                    async:false,
                    success: function (data) {
                        console.log(data);
                        if (data.success) {
                            $(".hint").text("");
                            $(".hint").css("display","none");
                            getCode=false;
                            var num=60;
                            $('.phoneCode span').css('background','#DCDFE2').html(num+'s');
                            timer=setInterval(function(){
                                num--;
                                $('.phoneCode span').css('background','#DCDFE2').html(num+'s');
                                if(num==0){
                                    clearInterval(timer)
                                    $('.phoneCode span').css('background','#1394FF').html('重新获取验证码');
                                    getCode=true;
                                }
                            },1000)

                        } else {

                            $(".hint").text(data.message);
                            $(".hint").css("display","block");
                            getCode=true;
                        }
                    }
                });


			}
		});

		$('.bindPhone').on('click',function(){
				testPhone();
				testPhoneCode();
			    var from = $("input[name='from']").val();
			    var phoneNumber = $("input[name='phoneNumber']").val();
		        var phoneCode =$("input[name='phoneCode']")	.val();
				if(fphone&&fphoneCode){
					$.ajax({
                      url:BASE_PATH+'/wechatCustomer/bind.htm',
					  data:{'phoneNumber':phoneNumber,'phoneCode':phoneCode,'from':from},
					  dataType:'json',
					  type:'post',
					  success:function(data){
                             if(data.success){
								 //绑定成功
								 var  resultMap = data.data;
								 var customerName = resultMap.customerName;
								 var customerId = resultMap.customerId;
								 var  companyId = resultMap.companyId;
								 var from = $("input[name='from']").val();
								 window.location.href=BASE_PATH+"/wechatCustomer/bindSuccess.htm?customerName="+customerName+"&customerId="+customerId+"&companyId="+companyId+"&from="+from+"&phoneNumber="+phoneNumber;
							 }else{

								 alert(data.message);
								if(data.data=="noInput"){
                                    window.location.href=BASE_PATH+"/wechatCustomer/bindFail.htm";
								}else {
                                    alert(data.message);
                                }

							 }
					  },
                      error:function(){
                        alert("网络错误,请刷新页面")
					  }
					});
				}
		})




//	// 运动效果
//	function animateHint(obj,src){
//		obj.show().html(src).stop().animate({top:'18%'},300,function(){
//	    	setTimeout(function(){
//	    		 obj.stop().animate({top:'100%'},200)},1500)
//	    });
//	}


})



</script>
</html>